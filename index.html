<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Haunted Block Hunt</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&display=swap">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://unpkg.com/@zxing/library@0.20.0"></script>
<style>
:root{--block-bg:#0b0b0e;--block-card:#14141a;--block-ink:#f6f3ff;--block-primary:#ff6600;--block-secondary:#ffffff}
body{background:linear-gradient(160deg,var(--block-bg),#171722);color:var(--block-ink);font-family:Poppins,system-ui,sans-serif;min-height:100svh}
.card{background:#14141a;border:1px solid #262433;border-radius:18px;box-shadow:0 6px 24px rgba(0,0,0,.35)}
.btn{border-radius:14px;padding:14px 18px;font-weight:700}
.btn-primary{background:linear-gradient(135deg,var(--block-primary),var(--block-secondary));color:#000}
.btn-muted{background:#272733;color:var(--block-ink)}
.badge{display:inline-flex;gap:.5rem;align-items:center;font-size:.8rem;color:#fff;background:#1d1c27;border:1px solid #2b2940;border-radius:999px;padding:.4rem .75rem}
.progress{height:8px;background:#262433;border-radius:999px;overflow:hidden}
.progress>span{display:block;height:100%;background:linear-gradient(90deg,var(--block-primary),var(--block-secondary))}
video{border-radius:12px}
.ghost{position:fixed;inset:auto 0 0 50%;translate:-50% 0;width:80px;height:80px;background:#fff;border-radius:40px 40px 16px 16px/50px 50px 16px 16px;box-shadow:0 8px 30px rgba(0,0,0,.35);opacity:.08;pointer-events:none;animation:float 6s ease-in-out infinite}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}
/* Win FX containers */
.win-wrap{position:fixed;inset:0;pointer-events:none;z-index:80}
.flash{position:fixed;inset:0;background:radial-gradient(circle at 50% 50%, rgba(255,200,90,.85), rgba(0,0,0,0) 60%);opacity:0}
.flash.show{animation:flashA .6s ease-out}@keyframes flashA{0%{opacity:1}100%{opacity:0}}
.shake{animation:shakeA .45s cubic-bezier(.36,.07,.19,.97)}
@keyframes shakeA{10%,90%{transform:translate3d(-2px,0,0)}20%,80%{transform:translate3d(4px,0,0)}30%,50%,70%{transform:translate3d(-6px,0,0)}40%,60%{transform:translate3d(6px,0,0)}}
.win-center{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%) scale(.7);opacity:0;filter:drop-shadow(0 0 24px rgba(255,180,60,.9))}
.win-center.show{animation:popA .7s ease-out forwards}
@keyframes popA{0%{opacity:0;transform:translate(-50%,-50%) scale(.6) rotate(-6deg)}60%{opacity:1;transform:translate(-50%,-50%) scale(1.08)}100%{opacity:1;transform:translate(-50%,-50%) scale(1)}}
.banner{position:fixed;left:50%;top:12%;transform:translateX(-50%);background:linear-gradient(135deg,#ffd35c,#fff3bf);color:#000;font-weight:800;padding:.6rem 1rem;border-radius:999px;box-shadow:0 10px 30px rgba(255,200,90,.35);opacity:0}
.banner.show{animation:bannerA .8s ease-out forwards}
@keyframes bannerA{0%{transform:translateX(-50%) translateY(-12px);opacity:0}100%{transform:translateX(-50%) translateY(0);opacity:1}}
.vignette{position:fixed;inset:0;box-shadow:inset 0 0 220px rgba(0,0,0,.7);opacity:0}
.vignette.show{animation:vigA .6s ease-out}@keyframes vigA{0%{opacity:1}100%{opacity:0}}
/* Particles (pumpkins + bats) */
.pump,.bat{position:fixed;will-change:transform,opacity;pointer-events:none;background-repeat:no-repeat;background-size:contain;filter:drop-shadow(0 0 8px rgba(255,220,120,.9))}
.pump{width:28px;height:28px}
.bat{width:56px;height:28px}
@media (prefers-reduced-motion:reduce){.shake,.flash.show,.win-center.show,.banner.show,.vignette.show{animation:none}}
</style>
</head>
<body class="p-4">
  <div class="max-w-md mx-auto space-y-4">
    <header class="flex items-center justify-between">
      <div class="flex items-center gap-2"><span class="badge">ðŸŽƒ Haunted Block Hunt</span></div>
      <nav class="flex items-center gap-3 text-sm">
        <a href="?admin=1" class="text-orange-400 underline">QR Codes</a>
        <a href="?stats=1" class="text-orange-400 underline">Stats</a>
      </nav>
    </header>
    <div id="game" class="space-y-4"></div>
    <div class="ghost"></div>
  </div>

  <div class="win-wrap" aria-hidden="true">
    <div id="fx-flash" class="flash"></div>
    <div id="fx-vig" class="vignette"></div>
    <div id="fx-banner" class="banner">ðŸŽƒ Spooktacular! +1 Stop</div>
    <div id="fx-center" class="win-center">
      <svg viewBox="0 0 128 128" width="180" aria-hidden="true">
        <defs><radialGradient id="pg" cx="50%" cy="45%" r="60%"><stop offset="0%" stop-color="#fff1b8"/><stop offset="70%" stop-color="#ffd35c"/><stop offset="100%" stop-color="#c07a00"/></radialGradient></defs>
        <ellipse cx="64" cy="70" rx="50" ry="40" fill="url(#pg)" stroke="#5b2e00" stroke-width="3"/>
        <rect x="58" y="18" width="12" height="12" rx="2" fill="#5b2e00"/>
        <path d="M36 62 l14 -10 14 10 M64 62 l14 -10 14 10" stroke="#000" stroke-width="8" stroke-linecap="round"/>
        <path d="M42 86 q22 16 44 0" fill="none" stroke="#000" stroke-width="10" stroke-linecap="round"/>
      </svg>
    </div>
  </div>

  <div id="audioGate" style="position:fixed;inset:auto 0 16px 0;display:flex;justify-content:center;pointer-events:none;z-index:90">
    <button id="audioGateBtn" onclick="enableSFX()" style="pointer-events:auto;background:#ffd35c;color:#000;font-weight:800;border-radius:999px;padding:.6rem 1rem;box-shadow:0 10px 30px rgba(255,200,90,.35);border:none">
      ðŸ”Š Enable Sound Effects
    </button>
  </div>

<script>
/* ===== Config ===== */
const EVENT_ID = "haunted-block-2025";

/* ===== WebAudio + Random SFX (SIX files) ===== */
let AC, masterGain, audioReady=false;
// Ensure these filenames exactly match your files (same folder as index.html)
const FILES = {
  hits: [
    'witch-laugh-95203.mp3',
    'ghoul-ghost-scares-169233.mp3',
    'creepy-wind-410541.mp3',
    'spooky-scary-sound-410563.mp3',
    'scary-transition-401717.mp3',
    'halloween-wolf-howling-410542.mp3'
  ],
};
const SFX = { buffers: {} };
const pick = arr => arr[Math.floor(Math.random()*arr.length)];

async function enableSFX(){
  if (audioReady) return;
  const gate=document.getElementById('audioGate'); if(gate) gate.remove();
  const Ctx = window.AudioContext||window.webkitAudioContext; if(!Ctx) return;
  AC = AC || new Ctx(); if(AC.state==='suspended'){ try{ await AC.resume(); }catch{} }
  masterGain = masterGain || AC.createGain(); masterGain.gain.value = 1.0; masterGain.connect(AC.destination);
  audioReady = true;
  FILES.hits.forEach(u=>loadBuf(u));
}
window.addEventListener('pointerdown', ()=>{ if(!audioReady) enableSFX(); }, {once:true,capture:true});

async function loadBuf(url){
  try{
    const res = await fetch(url, { cache: 'force-cache' });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const arr = await res.arrayBuffer();
    const buf = await new Promise((ok,no)=>AC.decodeAudioData(arr, ok, no));
    SFX.buffers[url] = buf;
  }catch(e){ /* ignore; synth fallback covers */ }
}
function playBuf(url, vol=1, delay=0){
  const buf = SFX.buffers[url];
  if (!AC || !buf) return;
  const src = AC.createBufferSource(); const g = AC.createGain(); g.gain.value = vol;
  src.buffer = buf; src.connect(g); g.connect(masterGain); src.start(AC.currentTime + delay);
}
function synthThunder(){
  if(!AC) return; const dur = 1.8;
  const nb = AC.createBuffer(1, Math.max(1, AC.sampleRate*dur|0), AC.sampleRate);
  const d = nb.getChannelData(0);
  for(let i=0;i<d.length;i++){ const t=i/AC.sampleRate, env=Math.pow(1-Math.min(1,t/dur),1.2); d[i]=(Math.random()*2-1)*env; }
  const n = AC.createBufferSource(); n.buffer=nb;
  const lp = AC.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=1600;
  const g = AC.createGain(); g.gain.value=0.9;
  n.connect(lp); lp.connect(g); g.connect(masterGain); n.start();
}
function playHitRandom(){
  const choice = pick(FILES.hits);
  if (SFX.buffers[choice]) playBuf(choice, 1.0, 0);
  else synthThunder();
}

/* ===== Pumpkin & Bat SVG data-URIs ===== */
function pumpkinURI(){
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
    <defs><radialGradient id="g" cx="50%" cy="40%" r="60%">
      <stop offset="0%" stop-color="#fff7cf"/><stop offset="70%" stop-color="#ffd35c"/><stop offset="100%" stop-color="#c07a00"/>
    </radialGradient></defs>
    <ellipse cx="32" cy="36" rx="22" ry="16" fill="url(#g)" stroke="#7a4900" stroke-width="2"/>
    <rect x="29" y="14" width="6" height="6" rx="1" fill="#7a4900"/>
  </svg>`;
  return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg);
}
function batURI(){
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 56 28">
    <path d="M2,14 C10,8 14,8 22,12 C24,6 32,6 34,12 C42,8 46,8 54,14 C46,16 42,18 34,16 C32,22 24,22 22,16 C14,18 10,16 2,14 Z"
      fill="#fff6d6" stroke="#e6c77a" stroke-width="1"/>
  </svg>`;
  return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg);
}

/* ===== Game Data ===== */
const STOPS = [
  { id:"stop-el-chamo", business:"El Chamo", title:"Venezuelan Vampire Bites", riddle:"A hungry vampire craves arepasâ€”follow the smell of sizzling corn cakes!" },
  { id:"stop-kukri", business:"Kukri", title:"Crispy Chicken Crown", riddle:"A raven guards a crispy crownâ€”find the throne of the mighty chicken!" },
  { id:"stop-stackers", business:"Stackers", title:"Tower of Treats", riddle:"Towering patties rise like midnight moonsâ€”seek the tallest stack!" },
  { id:"stop-bubble-bliss", business:"Bubble Bliss", title:"Potions & Candle Charms", riddle:"Witchesâ€™ sweets that you donâ€™t eatâ€”find the place where potions fizz and candles glow." },
  { id:"stop-thicc-pizza", business:"Thicc Pizza", title:"Haunted Pizza Oven", riddle:"The oven roars like dragon fireâ€”where slices are thick and spirits gather." },
  { id:"stop-top-of-the-block-bar", business:"Top of The Block", title:"Phantomâ€™s Toast Above", riddle:"Clink! A phantomâ€™s toast echoes from aboveâ€”follow the lantern light." },
  { id:"stop-tavern-on-the-green", business:"Tavern on the Green", title:"Greenlit Goblin Tavern", riddle:"In the garden of night, goblins cheerâ€”find the green-lit haunt." },
  { id:"stop-link-link", business:"Link Link", title:"Enchanted Chain Forge", riddle:"A spark seals a spellâ€”seek the forge where golden links are bound." },
  { id:"stop-los-tacos", business:"Los Tacos", title:"Whispers of Smoky Spice", riddle:"Skeletons whisper of smoky spiceâ€”seek the stand where tacos rise." },
  { id:"stop-wow-wow-lemonade", business:"Wow Wow Lemonade", title:"Witchâ€™s Lemon Brew", riddle:"Sour turns sweet in this brewâ€”find the brightest yellow stand." },
  { id:"stop-teriyaki-queen", business:"Teriyaki Queen", title:"The Queenâ€™s Sizzling Cauldron", riddle:"The Queenâ€™s cauldron sizzles sweet and darkâ€”follow the charred trail of soy and fire." },
  { id:"stop-boba-lounge", business:"The Boba Lounge", title:"Ghost Bubble Parlor", riddle:"Ghosts sip floating pearlsâ€”seek the lounge of bubbling orbs." },
  { id:"stop-busy-bee-custard", business:"Busy Bee Frozen Custard", title:"Boo-Bee Freezer", riddle:"Buzz to the coldest hiveâ€”your clue chills by creamy swirls." },
  { id:"stop-enchanted-books", business:"Enchanted Books", title:"Ghostly Library", riddle:"A friendly phantom turns pagesâ€”find the whispering shelves." },
  { id:"stop-rez-sandwich", business:"Thatâ€™s My Rez Sandwich", title:"Spirit Sandwich Shop", riddle:"Spells stacked between breadâ€”seek the spirit of the sandwich." },
  { id:"stop-candy-bar", business:"The Candy Bar", title:"Trick-or-Treat Counter", riddle:"Count the sweets if you dareâ€”trick-or-treats await your stare." }
];

/* ===== State / UI ===== */
const KEY=(k)=>`${EVENT_ID}:${k}`, $=(s)=>document.querySelector(s);
let team=localStorage.getItem(KEY('team'))||''; let index=parseInt(localStorage.getItem(KEY('index'))||'0',10);
function save(){ localStorage.setItem(KEY('team'),team); localStorage.setItem(KEY('index'),String(index)); }
const wrapCard=(inner)=>`<div class="card p-4">${inner}</div>`;
const escapeHtml=(s)=>s.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]));
function header(pct){
  return `<div class="card p-4">
    <div class="flex items-center justify-between mb-3">
      <span class="badge">Team: ${team?`<strong>${escapeHtml(team)}</strong>`:'â€”'}</span>
      <button class="btn btn-muted text-sm" onclick="resetProgress()">Restart</button>
    </div>
    <div class="progress"><span style="width:${pct}%"></span></div>
    <div class="text-xs text-violet-200 mt-1">${index}/${STOPS.length}</div>
  </div>`;
}
function render(){
  const p=new URL(location.href).searchParams;
  if(p.get('stats')) return renderStats();
  if(p.get('admin')) return renderAdmin();
  let html=''; const pct=Math.round((index/STOPS.length)*100);
  if(!team){
    html+=wrapCard(`<h1 class="text-xl font-bold mb-1">Welcome, brave hunters! ðŸ‘»</h1>
    <p class="text-sm text-gray-400 mb-3">Enter your team name to begin. Visit each business, scan the QR, and unlock the next clue.</p>
    <input id="teamInput" class="w-full px-3 py-3 rounded-lg border border-zinc-700 bg-zinc-900" placeholder="Team name">
    <button class="btn btn-primary w-full mt-3" onclick="startTeam()">Start Hunt</button>`);
    $("#game").innerHTML=html; return;
  }
  html+=header(pct);
  if(index<STOPS.length){
    const cur=STOPS[index];
    html+=wrapCard(`<div class="text-sm text-gray-400 mb-1">Stop #${index+1}: <span class="font-semibold">${cur.business}</span></div>
      <h2 class="text-lg font-bold mb-1">${cur.title}</h2><p class="text-base">${cur.riddle}</p>`);
    html+=wrapCard(`<div class="text-sm text-gray-400 mb-2">Scan the checkpoint QR at <strong>${cur.business}</strong></div>
      <div id="camera" class="overflow-hidden rounded-lg border border-zinc-700">
        <video id="preview" style="width:100%;height:auto" autoplay muted playsinline></video>
      </div>
      <div class="text-xs text-gray-500 mt-2">If the camera doesnâ€™t start, allow camera permissions in your browser.</div>`);
    $("#game").innerHTML=html; startScanner(cur.id);
  }else{
    html+=wrapCard(`<h1 class="text-2xl font-bold text-center">ðŸŽ‰ You did it!</h1>
      <p class="text-base text-center mt-1">Team <strong>${escapeHtml(team)}</strong> completed the Haunted Block Hunt!</p>
      <p class="text-sm text-gray-400 text-center">Show this screen at the prize table to claim your treat. Happy Halloween! ðŸŽƒ</p>
      <div class="grid grid-cols-1 gap-2 mt-3">
        <button class="btn btn-primary" onclick="celebrate()">Celebrate Again</button>
        <button class="btn btn-muted" onclick="resetProgress()">Play Again</button>
      </div>`);
    $("#game").innerHTML=html; celebrate();
  }
}
function renderAdmin(){
  let html='';
  html+=wrapCard(`<div class="flex items-center justify-between">
    <h1 class="text-xl font-bold">Checkpoint QR Codes</h1>
    <div class="text-sm text-orange-400">Print and place at each business. Each QR encodes the stop id.</div>
  </div>`);
  html+=`<div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2">`;
  STOPS.forEach(s=>{
    html+=`<div class="card p-4"><div class="text-xs text-gray-400">${s.business}</div>
      <div class="font-bold">${s.title}</div><div id="qr-${s.id}" class="flex items-center justify-center my-3"></div>
      <div class="text-xs text-gray-400 break-all">${s.id}</div></div>`;
  });
  html+=`</div>`;
  $("#game").innerHTML=html;
  STOPS.forEach(s=> new QRCode(document.getElementById(`qr-${s.id}`), { text:s.id, width:180, height:180, correctLevel: QRCode.CorrectLevel.M }));
}
function renderStats(){ $("#game").innerHTML=wrapCard(`<h1 class="text-xl font-bold">Stats</h1><p class="text-sm text-gray-400">Local-only counters on this device.</p>`); }
function startTeam(){ enableSFX(); const inp=$("#teamInput"); const t=(inp.value||'').trim(); if(!t) return; team=t; index=0; save(); render(); }
function resetProgress(){ localStorage.removeItem(KEY('team')); localStorage.removeItem(KEY('index')); team=''; index=0; render(); }

/* ===== Celebrate FX ===== */
function pumpkinURI(){ const svg=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><defs><radialGradient id="g" cx="50%" cy="40%" r="60%"><stop offset="0%" stop-color="#fff7cf"/><stop offset="70%" stop-color="#ffd35c"/><stop offset="100%" stop-color="#c07a00"/></radialGradient></defs><ellipse cx="32" cy="36" rx="22" ry="16" fill="url(#g)" stroke="#7a4900" stroke-width="2"/><rect x="29" y="14" width="6" height="6" rx="1" fill="#7a4900"/></svg>`; return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg); }
function batURI(){ const svg=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 56 28"><path d="M2,14 C10,8 14,8 22,12 C24,6 32,6 34,12 C42,8 46,8 54,14 C46,16 42,18 34,16 C32,22 24,22 22,16 C14,18 10,16 2,14 Z" fill="#fff6d6" stroke="#e6c77a" stroke-width="1"/></svg>`; return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg); }
function spawnPumpkinBurst(n=110){
  const cx=innerWidth/2, cy=innerHeight/2, bg=pumpkinURI();
  for(let i=0;i<n;i++){
    const el=document.createElement('div'); el.className='pump'; el.style.left=cx+'px'; el.style.top=cy+'px'; el.style.backgroundImage=`url("${bg}")`;
    const a=(i/n)*2*Math.PI+Math.random()*0.7, dist=140+Math.random()*360, dx=Math.cos(a)*dist, dy=Math.sin(a)*dist, rot=(Math.random()*240-120)+'deg', dur=900+Math.random()*700;
    el.animate([{transform:'translate(-50%,-50%) scale(0.85) rotate(0)',opacity:1},{transform:`translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px)) scale(0.95) rotate(${rot})`,opacity:0}],{duration:dur,easing:'cubic-bezier(.2,.8,.2,1)',fill:'forwards'});
    document.body.appendChild(el); setTimeout(()=>el.remove(),dur+60);
  }
}
function spawnLightBats(count=12){
  const bg=batURI();
  for(let i=0;i<count;i++){
    const b=document.createElement('div'); b.className='bat'; b.style.backgroundImage=`url("${bg}")`;
    const y=0.15*innerHeight+Math.random()*0.7*innerHeight; b.style.left='-60px'; b.style.top=y+'px';
    b.animate([{transform:'translate(-50px,0) rotate(-6deg)',opacity:0.98},{transform:`translate(${innerWidth+60}px,-8vh) rotate(10deg)`,opacity:0.95}],{duration:2500+Math.random()*1800,easing:'ease-in-out',fill:'forwards'});
    document.body.appendChild(b); setTimeout(()=>b.remove(),4600);
  }
}
function celebrate(){ spawnPumpkinBurst(110); spawnLightBats(12); }
function showMegaWinFX(){
  if(navigator.vibrate) navigator.vibrate([40,40,60]);
  const flash=document.getElementById('fx-flash'), vig=document.getElementById('fx-vig');
  document.documentElement.classList.add('shake'); flash.classList.add('show'); vig.classList.add('show');
  setTimeout(()=>{ flash.classList.remove('show'); vig.classList.remove('show'); document.documentElement.classList.remove('shake'); }, 650);
  const center=document.getElementById('fx-center'), banner=document.getElementById('fx-banner');
  center.classList.add('show'); banner.classList.add('show'); setTimeout(()=>{ center.classList.remove('show'); banner.classList.remove('show'); }, 950);
  celebrate();
}

/* ===== Scanner ===== */
let codeReader; let scanLock=false;
function normalizeQRText(txt){
  if(!txt) return ''; let t=(''+txt).trim(); try{ t=decodeURIComponent(t); }catch(e){}
  try{ if(/^https?:/i.test(t)){ const u=new URL(t); const last=u.pathname.split('/').filter(Boolean).pop()||''; const hash=(u.hash||'').replace(/^#/,''); const q=(u.searchParams.get('id')||'')||(u.searchParams.get('stop')||''); const cand=[q,hash,last,t].filter(Boolean); const found=cand.find(v=>/stop-[a-z0-9-]+/i.test(v)); if(found){ const m=found.match(/stop-[a-z0-9-]+/i); return (m?m[0]:found).toLowerCase(); } return last.toLowerCase(); } }catch(e){}
  return t.toLowerCase();
}
async function getCameras(){
  if (ZXing?.BrowserMultiFormatReader?.listVideoInputDevices) return await ZXing.BrowserMultiFormatReader.listVideoInputDevices();
  if (navigator.mediaDevices?.enumerateDevices) return (await navigator.mediaDevices.enumerateDevices()).filter(d=>d.kind==='videoinput');
  return [];
}
async function startScanner(expectedId){
  stopScanner(); scanLock=false;
  try{ await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ideal:'environment'} } }); }catch(e){}
  codeReader=new ZXing.BrowserMultiFormatReader();
  try{
    const devices=await getCameras();
    let camId=devices?.[0]?.deviceId; const back=devices.find(d=>/back|rear|environment/i.test(d.label)); if(back) camId=back.deviceId;
    const expectedNorm = normalizeQRText(expectedId);
    await codeReader.decodeFromVideoDevice(camId,'preview',(result)=>{
      if(!result || scanLock) return;
      const got = normalizeQRText(result.getText());
      const isHit = got===expectedNorm || (got.includes('stop-') && got.includes(expectedNorm));
      if(isHit){
        scanLock=true;
        showMegaWinFX();
        playHitRandom(); setTimeout(playHitRandom, 420);
        index++; save(); if(index>=STOPS.length) localStorage.setItem(KEY('completed'),'1');
        stopScanner(); setTimeout(render, 480);
      } else {
        document.body.animate([{backgroundColor:'transparent'},{backgroundColor:'#2a0d0d'},{backgroundColor:'transparent'}],{duration:350});
      }
    });
  }catch(e){
    document.getElementById('camera').insertAdjacentHTML('afterend', `<div class="text-xs text-red-300 mt-2">Camera error: ${e?.message||e}</div>`);
  }
}
function stopScanner(){ try{ codeReader && codeReader.reset(); }catch(e){} }

/* ===== Boot ===== */
render();
</script>
</body>
</html>


