<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>The Block — Leprechaun Gold Hunt</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700;800&display=swap">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@zxing/library@0.20.0"></script>
  <!-- Optional (for intro/finale Lottie later) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

  <style>
    :root{
      --bg0:#07110a;
      --bg1:#062114;
      --card:rgba(10,26,16,.72);
      --stroke:rgba(255,255,255,.10);
      --ink:#f2fff4;
      --muted:rgba(242,255,244,.72);
      --gold:#ffd56a;
      --gold2:#ffb84a;
      --green:#2cff9a;
      --green2:#00d174;
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1100px 720px at 50% 15%, rgba(0,255,140,.16), rgba(0,0,0,0) 60%),
        radial-gradient(900px 600px at 80% 55%, rgba(255,213,106,.10), rgba(0,0,0,0) 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
    }
    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:18px;
      box-shadow:0 12px 40px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
    }
    .btn{
      border-radius:999px;
      padding:14px 18px;
      font-weight:800;
      letter-spacing:.2px;
      transition:transform .14s ease, filter .14s ease;
      user-select:none;
    }
    .btn:active{transform:scale(.98)}
    .btnPrimary{
      background:linear-gradient(135deg, var(--gold), var(--gold2));
      color:#1b1300;
      box-shadow:0 14px 36px rgba(255,195,90,.22);
    }
    .btnGhost{
      background:rgba(255,255,255,.08);
      border:1px solid var(--stroke);
      color:var(--ink);
    }
    .pill{
      border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      padding:8px 10px;
      font-size:12px;
      color:var(--muted);
    }
    .glowRing{
      box-shadow:0 0 0 1px rgba(255,255,255,.08), 0 0 24px rgba(0,255,140,.12);
    }
    .scanFrame{
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      overflow:hidden;
      position:relative;
      background:rgba(0,0,0,.25);
    }
    .scanFrame::after{
      content:"";
      position:absolute;
      inset:10px;
      border-radius:12px;
      border:2px dashed rgba(255,213,106,.35);
      pointer-events:none;
      animation:dash 2.4s linear infinite;
      mask: linear-gradient(#000, #000);
    }
    @keyframes dash{0%{opacity:.55}50%{opacity:1}100%{opacity:.55}}
    video{width:100%;height:auto;display:block}

    /* Full-screen FX canvas */
    #fxCanvas{
      position:fixed; inset:0;
      width:100%; height:100%;
      z-index:40;
      pointer-events:none;
    }

    /* Start gate */
    #gate{
      position:fixed; inset:0;
      z-index:200;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
      background:
        radial-gradient(1200px 800px at 50% 25%, rgba(0,255,140,.18), rgba(0,0,0,0) 65%),
        radial-gradient(1000px 650px at 50% 40%, rgba(255,213,106,.14), rgba(0,0,0,0) 62%),
        linear-gradient(180deg, #061b10, #041008);
    }
    .title{
      font-weight:900;
      letter-spacing:.5px;
      line-height:1.05;
      font-size:clamp(30px,7vw,56px);
      color:var(--gold);
      text-shadow:0 0 22px rgba(255,205,110,.24), 0 0 44px rgba(0,255,140,.16);
    }
    .sub{
      margin-top:10px;
      font-size:clamp(14px,3.2vw,18px);
      color:rgba(242,255,244,.82);
    }

    /* Leprechaun slot (sprite placeholder now; replace with real assets later) */
    .lepWrap{
      display:flex; align-items:center; gap:12px;
    }
    .lepSprite{
      width:78px; height:78px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(40px 40px at 30% 30%, rgba(255,213,106,.25), rgba(0,0,0,0) 60%),
        radial-gradient(50px 50px at 70% 70%, rgba(0,255,140,.18), rgba(0,0,0,0) 62%),
        rgba(255,255,255,.06);
      position:relative;
      overflow:hidden;
    }
    .lepSprite::after{
      content:"";
      position:absolute; inset:-20%;
      background:radial-gradient(closest-side, rgba(255,255,255,.12), rgba(0,0,0,0));
      animation:lepBob 2.1s ease-in-out infinite;
    }
    @keyframes lepBob{0%,100%{transform:translateY(2px)}50%{transform:translateY(-3px)}}

    /* Toast */
    #toast{
      position:fixed;
      left:12px;
      bottom:12px;
      z-index:220;
      max-width:min(520px, 92vw);
      background:rgba(8,14,10,.86);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:10px 12px;
      font:12px/1.35 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      color:rgba(242,255,244,.9);
      display:none;
      white-space:pre-wrap;
    }

    /* Finale overlay */
    #finalOverlay{
      position:fixed; inset:0;
      z-index:180;
      display:none;
      background:
        radial-gradient(900px 520px at 50% 25%, rgba(255,213,106,.18), rgba(0,0,0,0) 70%),
        radial-gradient(1000px 700px at 50% 65%, rgba(0,255,140,.14), rgba(0,0,0,0) 65%),
        rgba(0,0,0,.72);
      backdrop-filter: blur(10px);
    }
    #finalOverlay.show{display:flex}
  </style>
</head>

<body>
  <canvas id="fxCanvas"></canvas>

  <div class="max-w-md mx-auto px-3 py-4 space-y-3 relative z-50" id="appRoot"></div>

  <!-- Start Gate -->
  <div id="gate">
    <div class="max-w-md w-full card p-5 glowRing">
      <div class="lepWrap">
        <div class="lepSprite" aria-hidden="true"></div>
        <div>
          <div class="text-xs uppercase tracking-widest" style="color:rgba(242,255,244,.72)">The Block Presents</div>
          <div class="title mt-1">Leprechaun Gold Hunt</div>
        </div>
      </div>

      <p class="sub mt-3">
        Visit each spot, scan the QR checkpoint, and unlock the next rhyme.
        Sound and camera need your permission.
      </p>

      <div class="flex gap-2 mt-4">
        <button class="btn btnPrimary w-full" id="btnStart">Start Hunt</button>
      </div>

      <div class="mt-3 flex items-center justify-between">
        <div class="pill">Mobile-friendly • iPhone/Android</div>
        <div class="pill">15 stops • Final at Tavern</div>
      </div>
    </div>
  </div>

  <!-- Finale -->
  <div id="finalOverlay" class="items-center justify-center p-5">
    <div class="max-w-md w-full card p-6 text-center glowRing">
      <div class="text-3xl font-extrabold" style="color:var(--gold)">You found the gold!</div>
      <div class="mt-2 text-sm" style="color:rgba(242,255,244,.80)">
        Show this screen at the prize location to claim your reward.
      </div>
      <div class="mt-5 flex gap-2">
        <button class="btn btnGhost w-full" id="btnFinalSound">Replay Finale</button>
        <button class="btn btnPrimary w-full" id="btnFinalDone">Done</button>
      </div>
      <div class="mt-3 text-xs" style="color:rgba(242,255,244,.55)">
        The hunt is complete. This screen stays here (no restart).
      </div>
    </div>
  </div>

  <div id="toast"></div>

<script>
/* =========================================================
   1) Locked Game Data (FINAL TEXT)
   ========================================================= */
const EVENT_ID = "block-leprechaun-2026";
const GAME = {
  title: "The Block — Leprechaun Gold Hunt",
  finalId: "tavern_on_the_green",
  nodes: [
    {
      id:"benny_sausage_company",
      business:"Benny Sausage Company",
      stopTitle:"Pot O’ Sausages",
      clueText:
`A leprechaun danced and dropped his gold,
But stopped for sausages hot and bold.
If your nose says “YUM” and tummy says “GO,”
You found the place where sausages glow!`,
      voiceFile:"assets/audio/clue_benny_sausage_company.mp3",
      order:1
    },
    {
      id:"birria_estilo_zacatecas",
      business:"Birria Estilo Zacatecas",
      stopTitle:"Rainbow Taco Trail",
      clueText:
`At the end of the rainbow, tacos await,
Dripping with magic on every plate.
Follow the smell, don’t be slow,
The leprechaun whispers, “Tacos below!”`,
      voiceFile:"assets/audio/clue_birria_estilo_zacatecas.mp3",
      order:2
    },
    {
      id:"bubble_bliss",
      business:"Bubble Bliss",
      stopTitle:"Lucky Bubble Lab",
      clueText:
`No eating here, don’t take a bite,
These fizzy treasures are bath-time delight.
Potions that bubble, sparkle, and hiss,
Find the leprechaun’s bubbly bliss!`,
      voiceFile:"assets/audio/clue_bubble_bliss.mp3",
      order:3
    },
    {
      id:"busy_bee_frozen_custard",
      business:"Busy Bee Frozen Custard",
      stopTitle:"Frozen Clover Cream",
      clueText:
`Buzz buzz buzz goes the clover bee,
Guarding cold gold for you and me.
Swirls of magic, creamy and bright,
Find the frozen rainbow delight!`,
      voiceFile:"assets/audio/clue_busy_bee_frozen_custard.mp3",
      order:4
    },
    {
      id:"chickys_coffee",
      business:"Chicky’s Coffee",
      stopTitle:"Leprechaun Energy Brew",
      clueText:
`A sleepy leprechaun needed a sip,
Now he dances and does a jig flip!
Follow the smell of warm magic brew,
The lucky cup is waiting for you.`,
      voiceFile:"assets/audio/clue_chickys_coffee.mp3",
      order:5
    },
    {
      id:"dim_sum_dynasty",
      business:"Dim Sum Dynasty",
      stopTitle:"Fortune of Gold Dumplings",
      clueText:
`Tiny gold pillows, steamy and round,
A leprechaun’s treasure is almost found.
Lift the lid and follow the steam,
Dumpling magic like a dream!`,
      voiceFile:"assets/audio/clue_dim_sum_dynasty.mp3",
      order:6
    },
    {
      id:"el_chamo",
      business:"El Chamo",
      stopTitle:"Golden Pocket Feast",
      clueText:
`The leprechaun stuffed his lucky gold,
Into warm pockets crispy and bold.
If your nose starts dancing too,
The golden pocket waits for you!`,
      voiceFile:"assets/audio/clue_el_chamo.mp3",
      order:7
    },
    {
      id:"enchanted_books",
      business:"Enchanted Books",
      stopTitle:"Spellbook of Shamrocks",
      clueText:
`A magical book with clovers inside,
Hides secrets the leprechauns can’t hide.
Turn the pages, take a look,
Find the lucky storybook!`,
      voiceFile:"assets/audio/clue_enchanted_books.mp3",
      order:8
    },
    {
      id:"link_link",
      business:"Link Link",
      stopTitle:"Golden Charm Forge",
      clueText:
`Clink clink clink goes the gold,
Tiny treasures shiny and bold.
Chains of luck the leprechauns bring,
Find the place where charms cling!`,
      voiceFile:"assets/audio/clue_link_link.mp3",
      order:9
    },
    {
      id:"stackers_burgers",
      business:"Stackers Burgers",
      stopTitle:"Tower of Lucky Bites",
      clueText:
`High as a rainbow, burgers stack,
A leprechaun couldn’t resist a snack.
Follow the tower, don’t delay,
Lucky burgers lead the way!`,
      voiceFile:"assets/audio/clue_stackers_burgers.mp3",
      order:10
    },
    {
      id:"thats_my_rez_sandwich",
      business:"That’s My Rez Sandwich",
      stopTitle:"Lucky Sandwich Stop",
      clueText:
`Bread and magic stacked just right,
A leprechaun built this tasty bite.
If your belly says “YES!” and feet say “GO,”
The lucky sandwich shop you now know!`,
      voiceFile:"assets/audio/clue_thats_my_rez_sandwich.mp3",
      order:11
    },
    {
      id:"the_boba_lounge",
      business:"The Boba Lounge",
      stopTitle:"Rainbow Bubble Brew",
      clueText:
`Floating pearls in a magical cup,
The leprechaun drank it all up.
Sip the rainbow, follow the glow,
Find the bubbles that dance below!`,
      voiceFile:"assets/audio/clue_the_boba_lounge.mp3",
      order:12
    },
    {
      id:"the_candy_bar",
      business:"The Candy Bar",
      stopTitle:"Treasure of Sweet Gold",
      clueText:
`Candy coins and sugar delight,
Guarded by leprechauns day and night.
Sweetest treasure, shiny and bright,
Find the gold of sugary light!`,
      voiceFile:"assets/audio/clue_the_candy_bar.mp3",
      order:13
    },
    {
      id:"thicc_pizza",
      business:"Thicc Pizza",
      stopTitle:"Rectangle Gold Slice",
      clueText:
`Not round, not square, but long and bold,
A pizza shaped like bars of gold!
Follow the smell of cheesy delight,
The rectangle treasure is in sight!`,
      voiceFile:"assets/audio/clue_thicc_pizza.mp3",
      order:14
    },
    {
      id:"tavern_on_the_green",
      business:"Tavern on the Green",
      stopTitle:"Lucky Clover Tavern (Final)",
      clueText:
`Green lights glow where stories are told,
Of clovers, rainbows, and pots of gold.
Follow the glow, don’t be shy,
The lucky tavern stands nearby!`,
      voiceFile:"assets/audio/clue_tavern_on_the_green.mp3",
      order:15,
      isFinal:true
    }
  ],
  audio: {
    opening: "assets/audio/opening.mp3",
    finale: "assets/audio/finale.mp3",
    musicLoop: "assets/audio/music_loop.mp3",
    correct: [
      "assets/audio/correct_01.mp3",
      "assets/audio/correct_02.mp3",
      "assets/audio/correct_03.mp3",
      "assets/audio/correct_04.mp3",
      "assets/audio/correct_05.mp3"
    ],
    wrong: [
      "assets/audio/wrong_01.mp3",
      "assets/audio/wrong_02.mp3",
      "assets/audio/wrong_03.mp3",
      "assets/audio/wrong_04.mp3",
      "assets/audio/wrong_05.mp3"
    ],
    sfx: {
      coinBurst: "assets/audio/sfx_coin_burst.mp3",
      rainbowSweep: "assets/audio/sfx_rainbow_sweep.mp3"
    }
  }
};

/* =========================================================
   2) Storage + State
   ========================================================= */
const KEY = (k) => `${EVENT_ID}:${k}`;
const State = {
  team: localStorage.getItem(KEY("team")) || "",
  idx: Number(localStorage.getItem(KEY("idx")) || "0"),
  started: localStorage.getItem(KEY("started")) === "1",
  audioEnabled: localStorage.getItem(KEY("audioEnabled")) !== "0",
  musicEnabled: localStorage.getItem(KEY("musicEnabled")) !== "0",
  voiceEnabled: localStorage.getItem(KEY("voiceEnabled")) !== "0",
  sfxEnabled: localStorage.getItem(KEY("sfxEnabled")) !== "0",
  done: localStorage.getItem(KEY("done")) === "1",
};

function saveState(){
  localStorage.setItem(KEY("team"), State.team);
  localStorage.setItem(KEY("idx"), String(State.idx));
  localStorage.setItem(KEY("started"), State.started ? "1":"0");
  localStorage.setItem(KEY("audioEnabled"), State.audioEnabled ? "1":"0");
  localStorage.setItem(KEY("musicEnabled"), State.musicEnabled ? "1":"0");
  localStorage.setItem(KEY("voiceEnabled"), State.voiceEnabled ? "1":"0");
  localStorage.setItem(KEY("sfxEnabled"), State.sfxEnabled ? "1":"0");
  localStorage.setItem(KEY("done"), State.done ? "1":"0");
}

/* =========================================================
   3) Toast + Error hooks
   ========================================================= */
const toastEl = document.getElementById("toast");
function toast(msg){
  toastEl.style.display = "block";
  toastEl.textContent = String(msg);
  clearTimeout(toastEl._t);
  toastEl._t = setTimeout(()=>{ toastEl.style.display="none"; }, 6000);
}
window.addEventListener("error", e=> toast("Error: " + (e?.message||e)));
window.addEventListener("unhandledrejection", e=> toast("Promise: " + (e?.reason?.message||e.reason||e)));

/* =========================================================
   4) Audio Engine (WebAudio mixer + ducking; safe if files missing)
   ========================================================= */
const AudioEngine = (() => {
  let AC=null, masterGain=null, musicGain=null, voGain=null, sfxGain=null;
  let buffers = new Map();
  let musicNode=null;
  let currentVO=null;
  let unlocked=false;

  const LEVELS = {
    musicNormal: 0.35,
    musicDucked: 0.10,
    duckInMs: 80,
    duckOutMs: 320,
    vo: 1.0,
    sfx: 0.9
  };

  function hasCtx(){ return !!(window.AudioContext || window.webkitAudioContext); }

  async function unlock(){
    if(unlocked) return true;
    if(!hasCtx()) return false;

    const Ctx = window.AudioContext || window.webkitAudioContext;
    AC = AC || new Ctx({ latencyHint: "interactive" });
    if(AC.state === "suspended"){
      try{ await AC.resume(); }catch(e){ /* ignore */ }
    }

    masterGain = masterGain || AC.createGain();
    musicGain  = musicGain  || AC.createGain();
    voGain     = voGain     || AC.createGain();
    sfxGain    = sfxGain    || AC.createGain();

    masterGain.gain.value = 1.0;
    musicGain.gain.value = State.musicEnabled ? LEVELS.musicNormal : 0.0;
    voGain.gain.value = State.voiceEnabled ? 1.0 : 0.0;
    sfxGain.gain.value = State.sfxEnabled ? 1.0 : 0.0;

    musicGain.connect(masterGain);
    voGain.connect(masterGain);
    sfxGain.connect(masterGain);
    masterGain.connect(AC.destination);

    // micro "tick" to satisfy iOS
    try{
      const osc = AC.createOscillator();
      const g = AC.createGain();
      g.gain.value = 0.0001;
      osc.connect(g); g.connect(masterGain);
      osc.start(); osc.stop(AC.currentTime + 0.02);
    }catch{}

    unlocked = true;
    return true;
  }

  async function load(url){
    if(!url || buffers.has(url) || !AC) return;
    try{
      const res = await fetch(url, { cache:"force-cache" });
      if(!res.ok) return;
      const arr = await res.arrayBuffer();
      const buf = await new Promise((ok, no) => AC.decodeAudioData(arr, ok, no));
      buffers.set(url, buf);
    }catch{
      // missing or blocked -> ignore
    }
  }

  async function preloadCore(){
    if(!unlocked) return;
    // Load minimal set early; others can be lazy-loaded
    await Promise.all([
      load(GAME.audio.musicLoop),
      load(GAME.audio.opening),
      load(GAME.audio.finale),
      ...GAME.audio.correct.map(load),
      ...GAME.audio.wrong.map(load)
    ]);
  }

  function ramp(param, to, ms){
    if(!AC) return;
    const now = AC.currentTime;
    try{
      param.cancelScheduledValues(now);
      param.setValueAtTime(param.value, now);
      param.linearRampToValueAtTime(to, now + ms/1000);
    }catch{}
  }

  function duck(on){
    if(!unlocked) return;
    if(!State.musicEnabled){ ramp(musicGain.gain, 0.0, 80); return; }
    ramp(musicGain.gain, on ? LEVELS.musicDucked : LEVELS.musicNormal, on ? LEVELS.duckInMs : LEVELS.duckOutMs);
  }

  function stopNode(n){
    try{ n?.src?.stop(); }catch{}
    try{ n?.g?.disconnect(); }catch{}
  }

  function playBuffer(buf, {bus="sfx", vol=1, loop=false}={}){
    if(!AC || !buf) return null;
    const src = AC.createBufferSource();
    src.buffer = buf;
    src.loop = !!loop;

    const g = AC.createGain();
    g.gain.value = vol;

    if(bus==="music"){ src.connect(g); g.connect(musicGain); }
    else if(bus==="vo"){ src.connect(g); g.connect(voGain); }
    else { src.connect(g); g.connect(sfxGain); }

    try{ src.start(0); }catch{}
    return {src, g};
  }

  async function startMusic(){
    if(!unlocked || musicNode) return;
    await load(GAME.audio.musicLoop);
    const buf = buffers.get(GAME.audio.musicLoop);
    if(!buf) return; // missing file is OK
    musicNode = playBuffer(buf, {bus:"music", vol:1.0, loop:true});
  }

  function setToggles({music, voice, sfx}={}){
    if(typeof music === "boolean"){ State.musicEnabled = music; }
    if(typeof voice === "boolean"){ State.voiceEnabled = voice; }
    if(typeof sfx === "boolean"){ State.sfxEnabled = sfx; }

    if(unlocked){
      ramp(musicGain.gain, State.musicEnabled ? LEVELS.musicNormal : 0.0, 120);
      ramp(voGain.gain, State.voiceEnabled ? 1.0 : 0.0, 120);
      ramp(sfxGain.gain, State.sfxEnabled ? 1.0 : 0.0, 120);
    }
    saveState();
  }

  function pickNoRepeat(arr, last){
    if(!arr?.length) return null;
    if(arr.length === 1) return arr[0];
    let c = arr[Math.floor(Math.random()*arr.length)];
    if(c === last){
      c = arr[(arr.indexOf(c)+1) % arr.length];
    }
    return c;
  }

  let lastCorrect=null, lastWrong=null;

  async function playSFX(url){
    if(!unlocked || !State.sfxEnabled) return;
    await load(url);
    const buf = buffers.get(url);
    if(!buf) return;
    playBuffer(buf, {bus:"sfx", vol:LEVELS.sfx});
  }

  async function playVO(url){
    if(!unlocked || !State.voiceEnabled) return;
    await load(url);
    const buf = buffers.get(url);
    if(!buf) return;

    // stop any prior VO
    if(currentVO){ stopNode(currentVO); currentVO=null; }

    duck(true);
    currentVO = playBuffer(buf, {bus:"vo", vol:LEVELS.vo});
    const durationMs = Math.max(400, (buf.duration||0) * 1000);

    // restore after VO ends
    clearTimeout(playVO._t);
    playVO._t = setTimeout(()=>{
      currentVO = null;
      duck(false);
    }, durationMs + 60);
  }

  async function playCorrect(){
    const url = pickNoRepeat(GAME.audio.correct, lastCorrect);
    lastCorrect = url;
    await playVO(url);
  }
  async function playWrong(){
    const url = pickNoRepeat(GAME.audio.wrong, lastWrong);
    lastWrong = url;
    await playVO(url);
  }

  return {
    unlock,
    preloadCore,
    startMusic,
    playVO,
    playCorrect,
    playWrong,
    playSFX,
    setToggles,
    duck,
    get unlocked(){ return unlocked; }
  };
})();

/* =========================================================
   5) FX Engine (coins + rainbow sweep; lightweight)
   ========================================================= */
const FX = (() => {
  const canvas = document.getElementById("fxCanvas");
  const ctx = canvas.getContext("2d");
  let W=0,H=0, DPR=1;
  const parts = [];
  let running=false;

  function resize(){
    DPR = Math.min(2, window.devicePixelRatio || 1);
    W = Math.floor(window.innerWidth * DPR);
    H = Math.floor(window.innerHeight * DPR);
    canvas.width = W; canvas.height = H;
  }
  window.addEventListener("resize", resize, {passive:true});
  resize();

  function addCoinBurst(x,y, count=120){
    const cx = x*DPR, cy=y*DPR;
    for(let i=0;i<count;i++){
      const a = Math.random()*Math.PI*2;
      const sp = (1.0 + Math.random()*3.5) * DPR;
      parts.push({
        x:cx, y:cy,
        vx:Math.cos(a)*sp,
        vy:Math.sin(a)*sp - (1.2*DPR),
        life: 55 + Math.random()*35,
        r: (2.2 + Math.random()*2.8)*DPR,
        spin: (Math.random()*2-1)*0.25,
        t: Math.random()*Math.PI*2
      });
    }
  }

  function rainbowSweep(){
    // Simple sweep band across screen
    const band = {type:"rainbow", x:-W*0.3, life: 48};
    parts.push(band);
  }

  function tick(){
    if(!running) return;
    ctx.clearRect(0,0,W,H);

    for(let i=parts.length-1;i>=0;i--){
      const p=parts[i];

      if(p.type==="rainbow"){
        p.life--;
        p.x += W*0.05;
        const w = W*0.55;
        const grad = ctx.createLinearGradient(p.x,0,p.x+w,0);
        grad.addColorStop(0,"rgba(255,0,100,0)");
        grad.addColorStop(0.15,"rgba(255,80,0,0.22)");
        grad.addColorStop(0.35,"rgba(255,230,0,0.20)");
        grad.addColorStop(0.55,"rgba(0,255,140,0.18)");
        grad.addColorStop(0.75,"rgba(0,170,255,0.16)");
        grad.addColorStop(1,"rgba(160,0,255,0)");
        ctx.fillStyle = grad;
        ctx.fillRect(p.x, 0, w, H);
        if(p.life<=0) parts.splice(i,1);
        continue;
      }

      p.life--;
      p.x += p.vx;
      p.y += p.vy;
      p.vy += 0.045*DPR;
      p.t += p.spin;

      const alpha = Math.max(0, Math.min(1, p.life/70));
      ctx.globalAlpha = alpha;

      // coin: fill + subtle highlight
      ctx.fillStyle = "rgba(255,213,106,0.95)";
      ctx.beginPath();
      ctx.ellipse(p.x, p.y, p.r*(1.2 + 0.25*Math.sin(p.t)), p.r, p.t, 0, Math.PI*2);
      ctx.fill();

      ctx.fillStyle = "rgba(255,255,255,0.35)";
      ctx.beginPath();
      ctx.ellipse(p.x - p.r*0.25, p.y - p.r*0.25, p.r*0.35, p.r*0.22, p.t, 0, Math.PI*2);
      ctx.fill();

      if(p.life<=0) parts.splice(i,1);
    }

    ctx.globalAlpha = 1;
    requestAnimationFrame(tick);
  }

  function ensure(){
    if(running) return;
    running=true;
    requestAnimationFrame(tick);
  }

  return {
    ensure,
    coinBurst(x,y,count){ ensure(); addCoinBurst(x,y,count); },
    rainbow(){ ensure(); rainbowSweep(); }
  };
})();

/* =========================================================
   6) Scanner (ZXing) + validation
   ========================================================= */
const Scanner = (() => {
  let reader=null;
  let scanLock=false;

  function normalize(t){ return (""+t).trim().toLowerCase(); }

  function stop(){
    try{ reader?.reset(); }catch{}
    reader=null;
    scanLock=false;
    try{
      const v=document.getElementById("preview");
      const s=v?.srcObject;
      if(s?.getTracks) s.getTracks().forEach(t=>t.stop());
      if(v) v.srcObject=null;
    }catch{}
  }

  async function start(expectedId, onHit){
    stop();
    scanLock=false;

    const expected = normalize(expectedId);
    const videoEl = document.getElementById("preview");
    if(!videoEl) throw new Error("preview <video> missing");

    if(!navigator.mediaDevices?.getUserMedia){
      throw new Error("Camera not available (HTTPS required).");
    }

    // Warm up stream (helps iOS)
    const warm = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:{ ideal:"environment" } },
      audio:false
    });
    videoEl.srcObject = warm;
    await videoEl.play().catch(()=>{});

    let deviceId = null;
    try{
      const devices = await ZXing.BrowserMultiFormatReader.listVideoInputDevices();
      if(devices?.length){
        const back = devices.find(d => /back|rear|environment/i.test(d.label));
        deviceId = (back || devices.at(-1)).deviceId;
      }
    }catch{
      // ok
    }

    reader = new ZXing.BrowserMultiFormatReader();
    await reader.decodeFromVideoDevice(deviceId, "preview", (result, err) => {
      if(!result || scanLock) return;
      const got = normalize(result.getText());
      if(got !== expected) return;

      scanLock = true;
      onHit?.(got);
    });
  }

  return { start, stop };
})();

/* =========================================================
   7) UI Rendering
   ========================================================= */
const root = document.getElementById("appRoot");
const finalOverlay = document.getElementById("finalOverlay");

function progressUI(){
  const total = GAME.nodes.length;
  const done = Math.max(0, Math.min(total, State.idx));
  const dots = Array.from({length: total}, (_,i) => {
    const filled = i < done;
    return `<div style="
      width:10px;height:10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:${filled ? "rgba(255,213,106,.95)" : "rgba(255,255,255,.08)"};
      box-shadow:${filled ? "0 0 16px rgba(255,213,106,.14)" : "none"};
    "></div>`;
  }).join("");
  return `
    <div class="card p-3">
      <div class="flex items-center justify-between">
        <div class="text-sm font-bold">Progress</div>
        <div class="pill">${done}/${total}</div>
      </div>
      <div class="mt-2 flex flex-wrap gap-2">${dots}</div>
    </div>
  `;
}

function controlsUI(){
  const mkToggle = (label, key, val) => `
    <button class="pill" data-toggle="${key}" aria-pressed="${val}">
      ${label}: <span style="color:var(--gold)">${val ? "ON" : "OFF"}</span>
    </button>`;
  return `
    <div class="card p-3">
      <div class="flex items-center justify-between">
        <div class="text-sm font-bold">Sound</div>
        <div class="text-xs" style="color:rgba(242,255,244,.60)">${AudioEngine.unlocked ? "Enabled" : "Locked (tap Start)"}</div>
      </div>
      <div class="mt-2 flex flex-wrap gap-2">
        ${mkToggle("Music","musicEnabled",State.musicEnabled)}
        ${mkToggle("Voice","voiceEnabled",State.voiceEnabled)}
        ${mkToggle("SFX","sfxEnabled",State.sfxEnabled)}
      </div>
      <div class="mt-2 text-xs" style="color:rgba(242,255,244,.55)">
        Music ducks automatically during voice lines.
      </div>
    </div>
  `;
}

function clueCard(node){
  return `
    <div class="card p-4">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-xs uppercase tracking-widest" style="color:rgba(242,255,244,.65)">${node.business}</div>
          <div class="text-lg font-extrabold mt-1" style="color:var(--gold)">${node.stopTitle}</div>
        </div>
        <div class="lepSprite" title="Leprechaun guide (placeholder)"></div>
      </div>

      <div class="mt-3 whitespace-pre-line text-[15px]" style="color:rgba(242,255,244,.92)">
        ${escapeHTML(node.clueText)}
      </div>

      <div class="mt-3 flex gap-2">
        <button class="btn btnGhost w-full" id="btnReplayClue">Replay Clue</button>
      </div>
    </div>
  `;
}

function scannerCard(node){
  return `
    <div class="card p-4">
      <div class="text-sm" style="color:rgba(242,255,244,.75)">
        Scan the checkpoint QR at <span class="font-extrabold" style="color:var(--gold)">${node.business}</span>.
      </div>

      <div class="mt-3 scanFrame">
        <video id="preview" autoplay muted playsinline></video>
      </div>

      <div class="mt-3 flex gap-2">
        <button class="btn btnGhost w-full" id="btnRescan">Restart Camera</button>
      </div>

      <div class="mt-2 text-xs" style="color:rgba(242,255,244,.55)">
        If camera fails: allow permission, use the GitHub Pages HTTPS URL, and close other apps using the camera.
      </div>

      <div class="mt-2 text-xs" style="color:rgba(242,255,244,.45)">
        Checkpoint payload expected: <span class="font-mono">${node.id}</span>
      </div>
    </div>
  `;
}

function teamCard(){
  return `
    <div class="card p-4">
      <div class="text-sm font-bold">Team Name</div>
      <div class="mt-2 flex gap-2">
        <input id="teamInput" class="w-full px-3 py-3 rounded-xl bg-black/20 border border-white/10 outline-none"
          placeholder="Enter team name" value="${escapeAttr(State.team)}" />
        <button class="btn btnPrimary" id="btnSaveTeam">Save</button>
      </div>
      <div class="mt-2 text-xs" style="color:rgba(242,255,244,.55)">
        Stored on this device only.
      </div>
    </div>
  `;
}

function render(){
  // If already completed, show finale state
  if(State.done){
    Scanner.stop();
    showFinal();
    return;
  }

  const total = GAME.nodes.length;
  if(State.idx >= total){
    State.done = true;
    saveState();
    Scanner.stop();
    showFinal();
    return;
  }

  const node = GAME.nodes[State.idx];

  root.innerHTML = `
    <div class="card p-4">
      <div class="text-xs uppercase tracking-widest" style="color:rgba(242,255,244,.65)">The Block</div>
      <div class="text-xl font-extrabold mt-1">Leprechaun Gold Hunt</div>
      <div class="mt-2 text-sm" style="color:rgba(242,255,244,.70)">
        Scan each location’s QR to unlock the next clue.
      </div>
    </div>

    ${progressUI()}
    ${teamCard()}
    ${controlsUI()}
    ${clueCard(node)}
    ${scannerCard(node)}
  `;

  // Wire controls
  document.getElementById("btnSaveTeam").onclick = () => {
    const v = (document.getElementById("teamInput").value || "").trim();
    State.team = v;
    saveState();
    toast("Team saved.");
  };

  root.querySelectorAll("[data-toggle]").forEach(btn => {
    btn.onclick = () => {
      const k = btn.getAttribute("data-toggle");
      const next = !State[k];
      State[k] = next;
      AudioEngine.setToggles({
        music: State.musicEnabled,
        voice: State.voiceEnabled,
        sfx: State.sfxEnabled
      });
      render(); // refresh pills
    };
  });

  document.getElementById("btnReplayClue").onclick = async () => {
    if(!AudioEngine.unlocked) return toast("Sound is locked. Tap Start Hunt first.");
    await AudioEngine.playVO(node.voiceFile);
  };

  document.getElementById("btnRescan").onclick = () => startScanningForNode(node);

  // Auto-play clue VO (if available) when entering a node
  if(AudioEngine.unlocked){
    AudioEngine.playVO(node.voiceFile);
  }

  startScanningForNode(node);
}

async function startScanningForNode(node){
  try{
    await Scanner.start(node.id, async () => {
      // Correct scan
      FX.rainbow();
      FX.coinBurst(window.innerWidth*0.5, window.innerHeight*0.38, 140);
      if(navigator.vibrate) navigator.vibrate([110,60,150]);

      // SFX optional (won't crash if missing)
      AudioEngine.playSFX(GAME.audio.sfx.coinBurst);

      // Funny correct VO (random) – will duck music
      await AudioEngine.playCorrect();

      // Advance after a short beat
      setTimeout(async () => {
        Scanner.stop();

        const wasFinal = !!node.isFinal || node.id === GAME.finalId;
        State.idx = State.idx + 1;
        saveState();

        if(wasFinal || State.idx >= GAME.nodes.length){
          State.done = true;
          saveState();
          showFinal();
          await AudioEngine.playVO(GAME.audio.finale);
          // Finale FX
          FX.rainbow();
          FX.coinBurst(window.innerWidth*0.5, window.innerHeight*0.34, 220);
          return;
        }

        render();
      }, 850);
    });
  }catch(e){
    toast("Camera error: " + (e?.message || e));
  }
}

function showFinal(){
  finalOverlay.classList.add("show");
}

/* =========================================================
   8) Gate (Start Hunt): unlock audio + start music + optional opening VO
   ========================================================= */
const gate = document.getElementById("gate");
document.getElementById("btnStart").onclick = async () => {
  gate.style.opacity = "0";
  gate.style.transition = "opacity .28s ease";
  setTimeout(()=>gate.remove(), 300);

  State.started = true;
  saveState();

  // Unlock audio, preload core, start music, then opening VO (if files exist)
  await AudioEngine.unlock();
  await AudioEngine.preloadCore();
  AudioEngine.setToggles({
    music: State.musicEnabled,
    voice: State.voiceEnabled,
    sfx: State.sfxEnabled
  });

  await AudioEngine.startMusic();
  await AudioEngine.playVO(GAME.audio.opening);

  render();
};

document.getElementById("btnFinalSound").onclick = async () => {
  if(!AudioEngine.unlocked) return;
  await AudioEngine.playVO(GAME.audio.finale);
};
document.getElementById("btnFinalDone").onclick = () => {
  // Keep final screen; no restart. Optionally fade to black could be added later.
  toast("Hunt complete.");
};

/* =========================================================
   9) Helpers
   ========================================================= */
function escapeHTML(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeAttr(s){
  return String(s).replaceAll('"',"&quot;");
}

/* =========================================================
   10) Boot
   ========================================================= */
(function boot(){
  // If user reloads mid-hunt, don’t show gate again; but audio still needs interaction to start.
  if(State.started){
    // Hide gate immediately
    gate.remove();
    render();

    // Add a gentle nudge if audio is locked
    if(!AudioEngine.unlocked){
      toast("Tap any button with sound controls after pressing Start Hunt next time to enable audio.");
    }
  }
})();
</script>
</body>
</html>


