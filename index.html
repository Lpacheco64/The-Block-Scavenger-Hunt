<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Haunted Block Hunt</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&display=swap">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@zxing/library@0.20.0"></script>
  <style>
    :root{--ink:#f6f3ff;--bg:#0b0b0e;--card:#14141a}
    body{background:#0b0b0e;color:var(--ink);font-family:Poppins,system-ui,sans-serif;min-height:100vh;padding:16px}
    .card{background:var(--card);border-radius:18px;box-shadow:0 6px 24px rgba(0,0,0,.35);padding:16px}
    .btn{border-radius:14px;padding:14px 18px;font-weight:700;background:#ff6600;color:#000}
    video{border-radius:12px}

    /* Particle sprites */
    .pump,.bat,.ghost{position:fixed;pointer-events:none;z-index:1000;background-size:100% 100%;background-repeat:no-repeat;will-change:transform,opacity}
    .pump{filter:drop-shadow(0 0 10px rgba(255,240,190,.9))}
    .bat {width:70px;height:36px;filter:drop-shadow(0 0 6px rgba(255,240,200,.7))}
    .ghost{width:52px;height:64px;filter:drop-shadow(0 0 10px rgba(255,255,255,.6))}
    #closingOverlay{position:fixed;inset:0;display:flex;flex-direction:column;justify-content:center;align-items:center;
      background:radial-gradient(circle at center,#000 30%,#0b0b0e 100%);color:#fff;z-index:2000;text-align:center}
  </style>
</head>
<body>
  <div id="game" class="max-w-md mx-auto space-y-4"></div>
  <!-- Closing music (place file next to this HTML) -->
  <audio id="closingMusic" src="halloween-spooky-music-411457.mp3"></audio>

<script>
/* ===================== CONFIG ===================== */
const EVENT_ID = "haunted-block-2025";

/* ===================== GAME DATA ===================== */
const STOPS = [
  { id:"stop-el-chamo", business:"El Chamo", title:"Venezuelan Vampire Bites", riddle:"A hungry vampire craves arepas‚Äîfollow the smell of sizzling corn cakes!" },
  { id:"stop-kukri", business:"Kukri", title:"Crispy Chicken Crown", riddle:"A raven guards a crispy crown‚Äîfind the throne of the mighty chicken!" },
  { id:"stop-stackers", business:"Stackers", title:"Tower of Treats", riddle:"Towering patties rise like midnight moons‚Äîseek the tallest stack!" },
  { id:"stop-bubble-bliss", business:"Bubble Bliss", title:"Potions & Candle Charms", riddle:"Witches‚Äô sweets that you don‚Äôt eat‚Äîfind the place where potions fizz and candles glow." },
  { id:"stop-thicc-pizza", business:"Thicc Pizza", title:"Haunted Pizza Oven", riddle:"The oven roars like dragon fire‚Äîwhere slices are thick and spirits gather." },
  { id:"stop-top-of-the-block-bar", business:"Top of The Block", title:"Phantom‚Äôs Toast Above", riddle:"Clink! A phantom‚Äôs toast echoes from above‚Äîfollow the lantern light." },
  { id:"stop-tavern-on-the-green", business:"Tavern on the Green", title:"Greenlit Goblin Tavern", riddle:"In the garden of night, goblins cheer‚Äîfind the green-lit haunt." },
  { id:"stop-link-link", business:"Link Link", title:"Enchanted Chain Forge", riddle:"A spark seals a spell‚Äîseek the forge where golden links are bound." },
  { id:"stop-los-tacos", business:"Los Tacos", title:"Whispers of Smoky Spice", riddle:"Skeletons whisper of smoky spice‚Äîseek the stand where tacos rise." },
  { id:"stop-wow-wow-lemonade", business:"Wow Wow Lemonade", title:"Witch‚Äôs Lemon Brew", riddle:"Sour turns sweet in this brew‚Äîfind the brightest yellow stand." },
  { id:"stop-teriyaki-queen", business:"Teriyaki Queen", title:"The Queen‚Äôs Sizzling Cauldron", riddle:"The Queen‚Äôs cauldron sizzles sweet and dark‚Äîfollow the charred trail of soy and fire." },
  { id:"stop-boba-lounge", business:"The Boba Lounge", title:"Ghost Bubble Parlor", riddle:"Ghosts sip floating pearls‚Äîseek the lounge of bubbling orbs." },
  { id:"stop-busy-bee-custard", business:"Busy Bee Frozen Custard", title:"Bee-Witched Custard", riddle:"Buzz to the coldest hive‚Äîyour clue chills by creamy swirls." },
  { id:"stop-enchanted-books", business:"Enchanted Books", title:"Ghostly Library", riddle:"A friendly phantom turns pages‚Äîfind the whispering shelves." },
  { id:"stop-rez-sandwich", business:"That‚Äôs My Rez Sandwich", title:"Spirit Sandwich Shop", riddle:"Spells stacked between bread‚Äîseek the spirit of the sandwich." },
  { id:"stop-candy-bar", business:"The Candy Bar", title:"Trick-or-Treat Counter", riddle:"Count the sweets if you dare‚Äîtrick-or-treats await your stare." }
];

/* ===================== STATE/UI ===================== */
const KEY = (k)=>`${EVENT_ID}:${k}`;
let team = localStorage.getItem(KEY('team')) || '';
let index = parseInt(localStorage.getItem(KEY('index'))||'0',10);
function save(){ localStorage.setItem(KEY('team'), team); localStorage.setItem(KEY('index'), String(index)); }
const wrapCard = (inner)=>`<div class="card">${inner}</div>`;

function render(){
  const root=document.getElementById('game');
  if(!team){
    root.innerHTML=wrapCard(`
      <h1 class="text-xl font-bold mb-1">Welcome, brave hunters! üëª</h1>
      <p class="text-sm text-gray-400 mb-3">Enter your team name to begin. Visit each business, scan the QR, and unlock the next clue.</p>
      <input id="teamInput" class="w-full px-3 py-3 rounded-lg border border-zinc-700 bg-zinc-900" placeholder="Team name">
      <button class="btn w-full mt-3" onclick="startTeam()">Start Hunt</button>`);
    return;
  }
  if(index<STOPS.length){
    const cur=STOPS[index];
    root.innerHTML =
      wrapCard(`<h2 class="text-lg font-bold">${cur.title}</h2><p>${cur.riddle}</p>`) +
      wrapCard(`<div class="text-sm text-gray-400 mb-2">Scan the checkpoint QR at <strong>${cur.business}</strong></div>
        <div id="camera" class="overflow-hidden rounded-lg border border-zinc-700">
          <video id="preview" style="width:100%;height:auto" autoplay muted playsinline></video>
        </div>
        <div class="text-xs text-gray-500 mt-2">If the camera doesn‚Äôt start, allow camera permissions in your browser.</div>`);
    startScanner(cur.id);
  } else {
    finale();
  }
}
function startTeam(){
  const inp=document.getElementById('teamInput'); 
  team=(inp.value||'').trim(); index=0; save(); render();
}

/* ===================== SCANNER ===================== */
let codeReader; let scanLock=false;
function normalizeQRText(txt){return (''+txt).trim().toLowerCase();}

async function startScanner(expectedId){
  stopScanner(); scanLock=false;
  const expectedNorm=normalizeQRText(expectedId);
  codeReader=new ZXing.BrowserMultiFormatReader();
  try{
    await codeReader.decodeFromVideoDevice(null,'preview',(result,err)=>{
      if (!result || scanLock) return;
      const got=normalizeQRText(result.getText());
      if (got!==expectedNorm) return;
      scanLock=true;
      spawnBurst(140,false);              // << pumpkins + bats + ghosts
      index++; save(); stopScanner();
      setTimeout(render, 900);
    });
  }catch(e){
    document.getElementById('camera')?.insertAdjacentHTML(
      'afterend', `<div class="text-xs text-red-300 mt-2">Camera error: ${e}</div>`);
  }
}
function stopScanner(){try{codeReader&&codeReader.reset();}catch{}}

/* ===================== SPRITES (SVG data URIs) ===================== */
function pumpkinURI(variant='orange', face=false){
  // richer pumpkin with ribs; faces rare by default
  let gradTop='#ffe8b3', gradMid='#ffb347', gradBot='#b25a00', stroke='#6e3a00';
  if(variant==='white'){ gradTop='#ffffff'; gradMid='#f0f0f0'; gradBot='#bdbdbd'; stroke='#6f6f6f'; }
  if(variant==='green'){ gradTop='#e8ffd9'; gradMid='#b7ff89'; gradBot='#337000'; stroke='#2a5700'; }
  const showFace = face || (Math.random() < 0.10);
  const faceSVG = showFace ? `
    <path d="M20 40 q12 10 24 0" fill="none" stroke="#1a1206" stroke-width="3" stroke-linecap="round"/>
    <circle cx="26" cy="34" r="2.2" fill="#1a1206"/><circle cx="38" cy="34" r="2.2" fill="#1a1206"/>
  ` : '';
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
    <defs><radialGradient id="g" cx="50%" cy="40%" r="62%">
      <stop offset="0%" stop-color="${gradTop}"/><stop offset="68%" stop-color="${gradMid}"/><stop offset="100%" stop-color="${gradBot}"/>
    </radialGradient></defs>
    <ellipse cx="32" cy="36" rx="23" ry="16.5" fill="url(#g)" stroke="${stroke}" stroke-width="2.2"/>
    <path d="M32 12 c-2 4 2 5 0 8" fill="none" stroke="${stroke}" stroke-width="2.4" stroke-linecap="round"/>
    <path d="M22 22 q-6 14 0 28" fill="none" stroke="${stroke}" stroke-opacity=".35" stroke-width="1.6"/>
    <path d="M28 20 q-6 16 0 32" fill="none" stroke="${stroke}" stroke-opacity=".35" stroke-width="1.6"/>
    <path d="M36 20 q6 16 0 32"  fill="none" stroke="${stroke}" stroke-opacity=".35" stroke-width="1.6"/>
    <path d="M42 22 q6 14 0 28"  fill="none" stroke="${stroke}" stroke-opacity=".35" stroke-width="1.6"/>
    ${faceSVG}
  </svg>`;
  return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg);
}
function batURI(){
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 32">
    <path d="M2,16 C10,10 14,10 22,14 C24,8 32,8 34,14 C42,10 46,10 62,16 C50,18 46,20 34,18 C32,24 24,24 22,18 C14,20 10,18 2,16 Z"
          fill="#fff6d6" stroke="#e6c77a" stroke-width="1"/>
  </svg>`;
  return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg);
}
function ghostURI(){
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 80">
    <defs><linearGradient id="gg" x1="0" x2="0" y1="0" y2="1">
      <stop offset="0%" stop-color="#ffffff" stop-opacity="0.95"/>
      <stop offset="100%" stop-color="#dfe8ff" stop-opacity="0.82"/>
    </linearGradient></defs>
    <path d="M12 28 Q12 6 32 6 Q52 6 52 28 V66 Q48 62 44 66 Q40 62 36 66 Q32 62 28 66 Q24 62 20 66 Q16 62 12 66 Z"
          fill="url(#gg)" stroke="#9fb3ff" stroke-opacity=".35" stroke-width="1.4"/>
    <circle cx="26" cy="30" r="3" fill="#2f3350"/>
    <circle cx="38" cy="30" r="3" fill="#2f3350"/>
  </svg>`;
  return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg);
}

/* ===================== BURSTS (pumpkins + bats + ghosts) ===================== */
function spawnBurst(count=140, big=false){
  const cx = innerWidth * (0.35 + Math.random()*0.3);
  const cy = innerHeight * (0.35 + Math.random()*0.3);
  const batImg = batURI(), ghostImg = ghostURI();
  const pumpkinVariants=['orange','white','green'];

  for (let i=0;i<count;i++){
    const roll = Math.random();
    if (roll < 0.65){
      // Pumpkin
      const p=document.createElement('div'); p.className='pump';
      const sizeBase = big ? 46 : 32;
      const size = sizeBase + Math.random()*(big?42:28);
      p.style.width=size+'px'; p.style.height=size+'px';
      p.style.left=cx+'px'; p.style.top=cy+'px';
      p.style.backgroundImage=`url("${pumpkinURI(pumpkinVariants[i%3], false)}")`;
      const angle = (i/count)*2*Math.PI + Math.random()*0.7;
      const dist  = (big?300:200) + Math.random()*(big?620:460);
      const dx=Math.cos(angle)*dist, dy=Math.sin(angle)*dist;
      const rot=(Math.random()*360-180)+'deg';
      const dur=2200 + Math.random()*1500;
      p.animate(
        [
          { transform:'translate(-50%,-50%) scale(0.85) rotate(0)', opacity:0.0 },
          { transform:'translate(-50%,-50%) scale(1.02) rotate(0)', opacity:1.0, offset:0.18 },
          { transform:`translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px)) scale(1.1) rotate(${rot})`, opacity:0 }
        ],
        { duration:dur, easing:'cubic-bezier(.15,.7,.2,1)', fill:'forwards' }
      );
      document.body.appendChild(p); setTimeout(()=>p.remove(), dur+280);
    } else if (roll < 0.85){
      // Bat (left-to-right glide)
      const b=document.createElement('div'); b.className='bat';
      b.style.backgroundImage=`url("${batImg}")`;
      const y = 0.1*innerHeight + Math.random()*0.8*innerHeight;
      b.style.left='-120px'; b.style.top=y+'px';
      const dur = 5200 + Math.random()*2200;
      const up = (Math.random() * 14) - 7;
      b.animate(
        [
          { transform: 'translate(-120px,0) rotate(-8deg)', opacity: 0.98 },
          { transform: `translate(${innerWidth+140}px, ${up}vh) rotate(12deg)`, opacity: 0.96 }
        ],
        { duration: dur, easing: 'ease-in-out', fill: 'forwards' }
      );
      document.body.appendChild(b); setTimeout(()=>b.remove(), dur+600);
    } else {
      // Ghost (float up & fade)
      const g=document.createElement('div'); g.className='ghost';
      g.style.backgroundImage=`url("${ghostImg}")`;
      const x = cx + (Math.random()*2-1) * (big?280:180);
      const y0 = cy + (Math.random()*80 - 40);
      g.style.left = x+'px'; g.style.top = (y0+60)+'px';
      const dur = 2600 + Math.random()*1800;
      g.animate(
        [
          { transform:'translate(-50%,-50%) scale(0.85)', opacity:0.0 },
          { transform:'translate(-50%,-60%) scale(1.0)', opacity:0.95, offset:0.2 },
          { transform:'translate(-50%,-120%) scale(1.05)', opacity:0.0 }
        ],
        { duration: dur, easing:'ease-out', fill:'forwards' }
      );
      document.body.appendChild(g); setTimeout(()=>g.remove(), dur+240);
    }
  }
}

/* ===================== FINALE ===================== */
function finale(){
  document.getElementById('game').innerHTML='';
  const overlay=document.createElement('div');overlay.id='closingOverlay';
  overlay.innerHTML=`<h1 class="text-4xl font-bold mb-4">üéâ You did it!</h1>
    <p class="text-lg mb-2">Team <strong>${team}</strong> completed the Haunted Block Hunt!</p>
    <p class="text-sm text-gray-300">Happy Halloween üéÉüëªüï∑Ô∏è</p>`;
  document.body.appendChild(overlay);

  // Big opening burst + rolling variety
  spawnBurst(420,true);
  const music=document.getElementById('closingMusic'); music?.play?.().catch(()=>{});
  const burstTimer = setInterval(()=>spawnBurst(160,false), 3200);
  setTimeout(()=>{ clearInterval(burstTimer); overlay.innerHTML+='<p class="mt-6 text-xs text-gray-500">The End</p>'; }, 30000);
}

/* ===================== BOOT ===================== */
render();
</script>
</body>
</html>
