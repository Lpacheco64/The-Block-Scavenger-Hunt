<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Haunted Block Hunt</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700;900&display=swap">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://unpkg.com/@zxing/library@0.20.0"></script>
<style>
:root{--block-bg:#0b0b0e;--block-card:#14141a;--block-ink:#f6f3ff;--block-primary:#ff6600;--block-secondary:#ffffff}
body{background:linear-gradient(160deg,var(--block-bg),#171722);color:var(--block-ink);font-family:Poppins,system-ui,sans-serif;min-height:100svh}
.card{background:#14141a;border:1px solid #262433;border-radius:18px;box-shadow:0 6px 24px rgba(0,0,0,.35)}
.btn{border-radius:14px;padding:14px 18px;font-weight:700}
.btn-primary{background:linear-gradient(135deg,var(--block-primary),var(--block-secondary));color:#000}
.btn-muted{background:#272733;color:var(--block-ink)}
.badge{display:inline-flex;gap:.5rem;align-items:center;font-size:.8rem;color:#fff;background:#1d1c27;border:1px solid #2b2940;border-radius:999px;padding:.4rem .75rem}
.progress{height:8px;background:#262433;border-radius:999px;overflow:hidden}
.progress>span{display:block;height:100%;background:linear-gradient(90deg,var(--block-primary),var(--block-secondary))}
video{border-radius:12px}
.ghost{position:fixed;inset:auto 0 0 50%;translate:-50% 0;width:80px;height:80px;background:#fff;border-radius:40px 40px 16px 16px/50px 50px 16px 16px;box-shadow:0 8px 30px rgba(0,0,0,.35);opacity:.08;pointer-events:none;animation:float 6s ease-in-out infinite}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}

/* Per-scan FX */
.win-wrap{position:fixed;inset:0;pointer-events:none;z-index:120}
.flash{position:fixed;inset:0;background:radial-gradient(circle at 50% 50%, rgba(255,200,90,.85), rgba(0,0,0,0) 60%);opacity:0}
.flash.show{animation:flashA .6s ease-out}@keyframes flashA{0%{opacity:1}100%{opacity:0}}
.shake{animation:shakeA .45s cubic-bezier(.36,.07,.19,.97)}
@keyframes shakeA{10%,90%{transform:translate3d(-2px,0,0)}20%,80%{transform:translate3d(4px,0,0)}30%,50%,70%{transform:translate3d(-6px,0,0)}40%,60%{transform:translate3d(6px,0,0)}}
.win-center{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%) scale(.7);opacity:0;filter:drop-shadow(0 0 24px rgba(255,180,60,.9))}
.win-center.show{animation:popA .7s ease-out forwards}
@keyframes popA{0%{opacity:0;transform:translate(-50%,-50%) scale(.6) rotate(-6deg)}60%{opacity:1;transform:translate(-50%,-50%) scale(1.08)}100%{opacity:1;transform:translate(-50%,-50%) scale(1)}}
.banner{position:fixed;left:50%;top:12%;transform:translateX(-50%);background:linear-gradient(135deg,#ffd35c,#fff3bf);color:#000;font-weight:800;padding:.6rem 1rem;border-radius:999px;box-shadow:0 10px 30px rgba(255,200,90,.35);opacity:0}
.banner.show{animation:bannerA .8s ease-out forwards}
@keyframes bannerA{0%{transform:translateX(-50%) translateY(-12px);opacity:0}100%{transform:translateX(-50%) translateY(0);opacity:1}}
.vignette{position:fixed;inset:0;box-shadow:inset 0 0 220px rgba(0,0,0,.7);opacity:0}
.vignette.show{animation:vigA .6s ease-out}@keyframes vigA{0%{opacity:1}100%{opacity:0}}

/* Particles */
.pump,.bat{position:fixed;will-change:transform,opacity;pointer-events:none;background-repeat:no-repeat;background-size:100% 100%;z-index:130}
.pump{width:42px;height:42px;filter:drop-shadow(0 0 10px rgba(255,220,120,.95))}
.bat{width:70px;height:36px;filter:drop-shadow(0 0 6px rgba(255,240,200,.7))}

/* GRAND FINALE (BIG) */
.finale{position:fixed;inset:0;background:radial-gradient(1400px 700px at 50% 30%, rgba(255,128,0,.10), rgba(0,0,0,.95));display:none;z-index:200}
.finale.show{display:block}
.finale .center{position:absolute;left:50%;top:42%;transform:translate(-50%,-50%);text-align:center}
.marquee{
  font-size:clamp(40px,10vw,112px);font-weight:900;letter-spacing:.05em;
  background:linear-gradient(180deg,#fff5d6,#ffd35c 40%,#b86a00 100%);
  -webkit-background-clip:text;background-clip:text;color:transparent;
  text-shadow:0 0 0 rgba(0,0,0,0);
  animation:marq 1.6s ease-out both, glow 2.2s ease-in-out infinite 1.6s
}
@keyframes marq{0%{transform:scale(.6) translateZ(0);filter:blur(6px);opacity:0}60%{transform:scale(1.1);opacity:1;filter:blur(0)}100%{transform:scale(1)}}
@keyframes glow{0%,100%{filter:drop-shadow(0 0 10px rgba(255,200,90,.55))}50%{filter:drop-shadow(0 0 26px rgba(255,200,90,.95))}}
.sub{color:#ffe6b3;opacity:.95;margin-top:.4rem;font-weight:700;font-size:clamp(16px,3.5vw,28px)}
.finale .spot{position:absolute;inset:0;pointer-events:none;mix-blend-mode:screen;background:radial-gradient(450px 220px at var(--x,50%) var(--y,30%), rgba(255,200,100,.3), rgba(0,0,0,0) 60%)}
.finale .strobe{position:absolute;inset:0;background:radial-gradient(400px 200px at 50% 40%, rgba(255,255,255,.8), rgba(0,0,0,0) 60%);opacity:0;pointer-events:none}
.finale .strobe.show{animation:stb .12s ease-out 8}@keyframes stb{0%{opacity:.85}100%{opacity:0}}
.finale .ring{position:absolute;left:50%;top:42%;transform:translate(-50%,-50%);width:min(90vw,700px);height:min(90vw,700px);border:6px solid rgba(255,200,90,.35);border-radius:9999px;filter:blur(2px);opacity:0;animation:ring 1.4s ease-out both .2s}
@keyframes ring{0%{transform:translate(-50%,-50%) scale(.3);opacity:0}100%{transform:translate(-50%,-50%) scale(1);opacity:1}}

/* Fog layer */
#fog{position:absolute;inset:0;opacity:.55;mix-blend-mode:screen;pointer-events:none}

/* a11y */
@media (prefers-reduced-motion:reduce){.shake,.flash.show,.win-center.show,.banner.show,.vignette.show,.marquee{animation:none}}
</style>
</head>
<body class="p-4">
  <div class="max-w-md mx-auto space-y-4">
    <header class="flex items-center justify-between">
      <div class="flex items-center gap-2"><span class="badge">ðŸŽƒ Haunted Block Hunt</span></div>
      <nav class="flex items-center gap-3 text-sm">
        <a href="?admin=1" class="text-orange-400 underline">QR Codes</a>
        <a href="?stats=1" class="text-orange-400 underline">Stats</a>
      </nav>
    </header>
    <div id="game" class="space-y-4"></div>
    <div class="ghost"></div>
  </div>

  <!-- Per-scan FX -->
  <div class="win-wrap" aria-hidden="true">
    <div id="fx-flash" class="flash"></div>
    <div id="fx-vig" class="vignette"></div>
    <div id="fx-banner" class="banner">ðŸŽƒ Spooktacular! +1 Stop</div>
    <div id="fx-center" class="win-center">
      <svg viewBox="0 0 128 128" width="180" aria-hidden="true">
        <defs><radialGradient id="pg" cx="50%" cy="45%" r="60%"><stop offset="0%" stop-color="#fff1b8"/><stop offset="70%" stop-color="#ffd35c"/><stop offset="100%" stop-color="#c07a00"/></radialGradient></defs>
        <ellipse cx="64" cy="70" rx="50" ry="40" fill="url(#pg)" stroke="#5b2e00" stroke-width="3"/>
        <rect x="58" y="18" width="12" height="12" rx="2" fill="#5b2e00"/>
        <path d="M36 62 l14 -10 14 10 M64 62 l14 -10 14 10" stroke="#000" stroke-width="8" stroke-linecap="round"/>
        <path d="M42 86 q22 16 44 0" fill="none" stroke="#000" stroke-width="10" stroke-linecap="round"/>
      </svg>
    </div>
  </div>

  <!-- GRAND FINALE (auto-closes after 30s) -->
  <div id="finale" class="finale" aria-hidden="true">
    <canvas id="fw" style="position:absolute;inset:0;width:100%;height:100%"></canvas>
    <canvas id="fog"></canvas>
    <div class="spot" id="spot"></div>
    <div class="strobe" id="strobe"></div>
    <div class="ring"></div>
    <div class="center">
      <div class="marquee">YOU DID IT!</div>
      <div class="sub">Team <span id="finaleTeam">â€”</span> completed the Haunted Block Hunt!</div>
    </div>
  </div>

  <!-- Sound gate -->
  <div id="audioGate" style="position:fixed;inset:auto 0 16px 0;display:flex;justify-content:center;pointer-events:none;z-index:220">
    <button id="audioGateBtn" onclick="enableSFX()" style="pointer-events:auto;background:#ffd35c;color:#000;font-weight:800;border-radius:999px;padding:.6rem 1rem;box-shadow:0 10px 30px rgba(255,200,90,.35);border:none">
      ðŸ”Š Enable Sound Effects
    </button>
  </div>

<script>
/* ===== Config ===== */
const EVENT_ID = "haunted-block-2025";

/* ===== Audio (6 hits + optional closing track) ===== */
let AC, masterGain, audioReady=false;
const FILES = {
  hits: [
    'witch-laugh-95203.mp3',
    'ghoul-ghost-scares-169233.mp3',
    'creepy-wind-410541.mp3',
    'spooky-scary-sound-410563.mp3',
    'scary-transition-401717.mp3',
    'halloween-wolf-howling-410542.mp3'
  ],
  closing: 'halloween-spooky-music-411457.mp3' // optional closing music
};
const SFX = { buffers: {}, windLoop:null, closingTrack:null };
const pick = arr => arr[Math.floor(Math.random()*arr.length)];

async function enableSFX(){
  if (audioReady) return;
  const gate=document.getElementById('audioGate'); if(gate) gate.remove();
  const Ctx = window.AudioContext||window.webkitAudioContext; if(!Ctx) return;
  AC = AC || new Ctx(); if(AC.state==='suspended'){ try{ await AC.resume(); }catch{} }
  masterGain = masterGain || AC.createGain(); masterGain.gain.value = 1.0; masterGain.connect(AC.destination);
  audioReady = true;
  [...FILES.hits, FILES.closing].forEach(u=>u && loadBuf(u));
}
window.addEventListener('pointerdown', ()=>{ if(!audioReady) enableSFX(); }, {once:true,capture:true});

async function loadBuf(url){
  try{
    const res = await fetch(url, { cache: 'force-cache' });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const arr = await res.arrayBuffer();
    const buf = await new Promise((ok,no)=>AC.decodeAudioData(arr, ok, no));
    SFX.buffers[url] = buf;
  }catch(e){}
}
function playBuf(url, vol=1, loop=false, when=0){
  const buf = SFX.buffers[url]; if(!AC || !buf) return null;
  const src = AC.createBufferSource(); const g = AC.createGain();
  g.gain.value = vol; src.buffer = buf; src.loop = loop;
  src.connect(g); g.connect(masterGain); src.start(AC.currentTime + when);
  return {src, g};
}
function stopNode(n){ try{ n?.src?.stop(); n?.g?.disconnect(); }catch(e){} }
function playHitRandom(){ const choice = pick(FILES.hits); if (SFX.buffers[choice]) playBuf(choice, 1.0, false, 0); }

/* ===== Pumpkin & Bat SVGs ===== */
function pumpkinURI(){
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
    <defs><radialGradient id="g" cx="50%" cy="40%" r="60%">
      <stop offset="0%" stop-color="#fffbe3"/><stop offset="70%" stop-color="#ffd35c"/><stop offset="100%" stop-color="#c07a00"/>
    </radialGradient></defs>
    <ellipse cx="32" cy="36" rx="22" ry="16" fill="url(#g)" stroke="#7a4900" stroke-width="2"/>
    <rect x="29" y="14" width="6" height="6" rx="1" fill="#7a4900"/>
  </svg>`;
  return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg);
}
function batURI(){
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 32">
    <path d="M2,16 C10,10 14,10 22,14 C24,8 32,8 34,14 C42,10 46,10 62,16 C50,18 46,20 34,18 C32,24 24,24 22,18 C14,20 10,18 2,16 Z"
    fill="#fff6d6" stroke="#e6c77a" stroke-width="1"/>
  </svg>`;
  return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg);
}

/* ===== Particles ===== */
function spawnPumpkinBurst(n=220){
  const cx=innerWidth/2, cy=innerHeight/2, bg=pumpkinURI();
  for(let i=0;i<n;i++){
    const el=document.createElement('div'); el.className='pump'; el.style.left=cx+'px'; el.style.top=cy+'px'; el.style.backgroundImage=`url("${bg}")`;
    const a=(i/n)*2*Math.PI+Math.random()*0.9, dist=220+Math.random()*520, dx=Math.cos(a)*dist, dy=Math.sin(a)*dist, rot=(Math.random()*360-180)+'deg', dur=1000+Math.random()*1200;
    el.animate(
      [{transform:'translate(-50%,-50%) scale(0.95) rotate(0)',opacity:1},
       {transform:`translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px)) scale(1.1) rotate(${rot})`,opacity:0}],
      {duration:dur,easing:'cubic-bezier(.2,.8,.2,1)',fill:'forwards'});
    document.body.appendChild(el); setTimeout(()=>el.remove(),dur+150);
  }
}
function spawnLightBats(count=34){
  const bg=batURI();
  for(let i=0;i<count;i++){
    const b=document.createElement('div'); b.className='bat'; b.style.backgroundImage=`url("${bg}")`;
    const y=0.1*innerHeight+Math.random()*0.8*innerHeight; b.style.left='-100px'; b.style.top=y+'px';
    b.animate(
      [{transform:'translate(-100px,0) rotate(-8deg)',opacity:.98},
       {transform:`translate(${innerWidth+120}px,${(Math.random()*-10)}vh) rotate(12deg)`,opacity:.96}],
      {duration:3000+Math.random()*2600,easing:'ease-in-out',fill:'forwards'});
    document.body.appendChild(b); setTimeout(()=>b.remove(),5800);
  }
}

/* ===== GRAND FINALE (HUGE) ===== */
let finaleTimer=null;
function grandFinale(){
  const overlay = document.getElementById('finale');
  document.getElementById('finaleTeam').textContent = escapeHtml(team||'â€”');
  overlay.classList.add('show');
  runSpotlight(); runFireworks(true); runFog();
  // strobes
  const st = document.getElementById('strobe'); st.classList.remove('show'); void st.offsetWidth; st.classList.add('show');
  // audio sequence
  if(audioReady){
    let at=0;
    ['scary-transition-401717.mp3','witch-laugh-95203.mp3','halloween-wolf-howling-410542.mp3','spooky-scary-sound-410563.mp3'].forEach(name=>{
      const b=SFX.buffers[name]; if(b){ playBuf(name,1.0,false,at); at += Math.min(2.6, b.duration||2.2)-0.1; }
    });
    const wind=SFX.buffers['creepy-wind-410541.mp3']; if(wind){ SFX.windLoop = playBuf('creepy-wind-410541.mp3',0.4,true,at); }
    const closing=SFX.buffers[FILES.closing]; if(closing){ SFX.closingTrack = playBuf(FILES.closing,0.6,false,at+1.2); }
  }
  // visuals
  spawnPumpkinBurst(260);
  spawnLightBats(40);
  setTimeout(()=>spawnPumpkinBurst(200), 800);
  setTimeout(()=>spawnLightBats(36), 1200);
  if(navigator.vibrate) navigator.vibrate([70,60,90,60,120]);

  clearTimeout(finaleTimer);
  finaleTimer=setTimeout(closeFinale, 15000);
}
function closeFinale(){
  const overlay = document.getElementById('finale');
  overlay.classList.remove('show');
  stopNode(SFX.windLoop); SFX.windLoop=null;
  stopNode(SFX.closingTrack); SFX.closingTrack=null;
}

/* Fireworks */
function runFireworks(big=false){
  const canvas = document.getElementById('fw'), ctx = canvas.getContext('2d');
  let w=canvas.width=innerWidth*devicePixelRatio, h=canvas.height=innerHeight*devicePixelRatio;
  const parts=[];
  function addBurst(x,y,color){
    const n=(big?160:100)+Math.random()*70;
    for(let i=0;i<n;i++){
      const ang=Math.random()*Math.PI*2, sp=(1.2+Math.random()*3.6)*(w/1600);
      parts.push({x,y,vx:Math.cos(ang)*sp,vy:Math.sin(ang)*sp,life:70+Math.random()*40,color,alpha:1});
    }
  }
  function tick(){
    ctx.clearRect(0,0,w,h);
    for(let i=parts.length-1;i>=0;i--){
      const p=parts[i]; p.x+=p.vx; p.y+=p.vy; p.vy+=0.018*devicePixelRatio; p.life--; p.alpha=Math.max(0,p.life/100);
      ctx.globalAlpha=p.alpha; ctx.fillStyle=p.color; ctx.beginPath(); ctx.arc(p.x,p.y, (big?3.1:2.4)*devicePixelRatio,0,Math.PI*2); ctx.fill();
      if(p.life<=0) parts.splice(i,1);
    }
    if(document.getElementById('finale').classList.contains('show')) requestAnimationFrame(tick);
  }
  function launch(){
    const x=(0.1+Math.random()*0.8)*w, y=(0.18+Math.random()*0.5)*h;
    const palette=['#ffd35c','#fff1b8','#ff8a00','#ffe6b3','#ffe07a','#ffffff'];
    addBurst(x,y, palette[Math.floor(Math.random()*palette.length)]);
  }
  const rate = big ? 280 : 420;
  const launchTimer=setInterval(launch,rate);
  window.addEventListener('resize',()=>{ w=canvas.width=innerWidth*devicePixelRatio; h=canvas.height=innerHeight*devicePixelRatio; });
  tick();
  const obs=new MutationObserver(()=>{ if(!document.getElementById('finale').classList.contains('show')){ clearInterval(launchTimer); obs.disconnect(); ctx.clearRect(0,0,w,h);} });
  obs.observe(document.getElementById('finale'),{attributes:true,attributeFilter:['class']});
}

/* Fog (simple Perlin-ish noise drift) */
function runFog(){
  const c = document.getElementById('fog'), x = c.getContext('2d');
  let W = c.width = innerWidth, H = c.height = innerHeight;
  const img = x.createImageData(W, H); const data = img.data; let t = 0;
  function noise(nx, ny){ // value noise
    function rnd(ix,iy){ const s=Math.sin(ix*127.1+iy*311.7)*43758.5453; return s - Math.floor(s); }
    const x0=Math.floor(nx), y0=Math.floor(ny), xf=nx-x0, yf=ny-y0;
    const v00=rnd(x0,y0), v10=rnd(x0+1,y0), v01=rnd(x0,y0+1), v11=rnd(x0+1,y0+1);
    const u=xf*xf*(3-2*xf), v=yf*yf*(3-2*yf);
    return (1-u)*(1-v)*v00 + u*(1-v)*v10 + (1-u)*v*v01 + u*v*v11;
  }
  function draw(){
    const s = 0.009; t += 0.003;
    for(let y=0, i=0; y<H; y++){
      for(let x0=0; x0<W; x0++, i+=4){
        const n = noise((x0+t*120)*s, (y+t*60)*s);
        const v = 220 + n*25;
        data[i]=v; data[i+1]=v; data[i+2]=v; data[i+3]=38; // alpha ~ 15%
      }
    }
    x.putImageData(img,0,0);
    if(document.getElementById('finale').classList.contains('show')) requestAnimationFrame(draw);
  }
  draw();
  addEventListener('resize',()=>{ W=c.width=innerWidth; H=c.height=innerHeight; });
}

/* Spotlight */
function runSpotlight(){
  const spot=document.getElementById('spot'); let t=0;
  (function step(){ t+=0.015; spot.style.setProperty('--x', (50+Math.sin(t)*30)+'%'); spot.style.setProperty('--y',(30+Math.cos(t*0.7)*8)+'%');
    if(document.getElementById('finale').classList.contains('show')) requestAnimationFrame(step);
  })();
}

/* ===== Game Data ===== */
const STOPS = [
  { id:"stop-el-chamo", business:"El Chamo", title:"Venezuelan Vampire Bites", riddle:"A hungry vampire craves arepasâ€”follow the smell of sizzling corn cakes!" },
  { id:"stop-kukri", business:"Kukri", title:"Crispy Chicken Crown", riddle:"A raven guards a crispy crownâ€”find the throne of the mighty chicken!" },
  { id:"stop-stackers", business:"Stackers", title:"Tower of Treats", riddle:"Towering patties rise like midnight moonsâ€”seek the tallest stack!" },
  { id:"stop-bubble-bliss", business:"Bubble Bliss", title:"Potions & Candle Charms", riddle:"Witchesâ€™ sweets that you donâ€™t eatâ€”find the place where potions fizz and candles glow." },
  { id:"stop-thicc-pizza", business:"Thicc Pizza", title:"Haunted Pizza Oven", riddle:"The oven roars like dragon fireâ€”where slices are thick and spirits gather." },
  { id:"stop-top-of-the-block-bar", business:"Top of The Block", title:"Phantomâ€™s Toast Above", riddle:"Clink! A phantomâ€™s toast echoes from aboveâ€”follow the lantern light." },
  { id:"stop-tavern-on-the-green", business:"Tavern on the Green", title:"Greenlit Goblin Tavern", riddle:"In the garden of night, goblins cheerâ€”find the green-lit haunt." },
  { id:"stop-link-link", business:"Link Link", title:"Enchanted Chain Forge", riddle:"A spark seals a spellâ€”seek the forge where golden links are bound." },
  { id:"stop-los-tacos", business:"Los Tacos", title:"Whispers of Smoky Spice", riddle:"Skeletons whisper of smoky spiceâ€”seek the stand where tacos rise." },
  { id:"stop-wow-wow-lemonade", business:"Wow Wow Lemonade", title:"Witchâ€™s Lemon Brew", riddle:"Sour turns sweet in this brewâ€”find the brightest yellow stand." },
  { id:"stop-teriyaki-queen", business:"Teriyaki Queen", title:"The Queenâ€™s Sizzling Cauldron", riddle:"The Queenâ€™s cauldron sizzles sweet and darkâ€”follow the charred trail of soy and fire." },
  { id:"stop-boba-lounge", business:"The Boba Lounge", title:"Ghost Bubble Parlor", riddle:"Ghosts sip floating pearlsâ€”seek the lounge of bubbling orbs." },
  { id:"stop-busy-bee-custard", business:"Busy Bee Frozen Custard", title:"Boo-Bee Freezer", riddle:"Buzz to the coldest hiveâ€”your clue chills by creamy swirls." },
  { id:"stop-enchanted-books", business:"Enchanted Books", title:"Ghostly Library", riddle:"A friendly phantom turns pagesâ€”find the whispering shelves." },
  { id:"stop-rez-sandwich", business:"Thatâ€™s My Rez Sandwich", title:"Spirit Sandwich Shop", riddle:"Spells stacked between breadâ€”seek the spirit of the sandwich." },
  { id:"stop-candy-bar", business:"The Candy Bar", title:"Trick-or-Treat Counter", riddle:"Count the sweets if you dareâ€”trick-or-treats await your stare." }
];

/* ===== State / UI ===== */
const KEY=(k)=>`${EVENT_ID}:${k}`, $=(s)=>document.querySelector(s);
let team=localStorage.getItem(KEY('team'))||''; let index=parseInt(localStorage.getItem(KEY('index'))||'0',10);
function save(){ localStorage.setItem(KEY('team'),team); localStorage.setItem(KEY('index'),String(index)); }
const wrapCard=(inner)=>`<div class="card p-4">${inner}</div>`;
const escapeHtml=(s)=>s.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]));
function header(pct){
  return `<div class="card p-4">
    <div class="flex items-center justify-between mb-3">
      <span class="badge">Team: ${team?`<strong>${escapeHtml(team)}</strong>`:'â€”'}</span>
      <button class="btn btn-muted text-sm" onclick="resetProgress()">Restart</button>
    </div>
    <div class="progress"><span style="width:${pct}%"></span></div>
    <div class="text-xs text-violet-200 mt-1">${index}/${STOPS.length}</div>
  </div>`;
}
function render(){
  const p=new URL(location.href).searchParams;
  if(p.get('stats')) return renderStats();
  if(p.get('admin')) return renderAdmin();
  let html=''; const pct=Math.round((index/STOPS.length)*100);
  if(!team){
    html+=wrapCard(`<h1 class="text-xl font-bold mb-1">Welcome, brave hunters! ðŸ‘»</h1>
    <p class="text-sm text-gray-400 mb-3">Enter your team name to begin. Visit each business, scan the QR, and unlock the next clue.</p>
    <input id="teamInput" class="w-full px-3 py-3 rounded-lg border border-zinc-700 bg-zinc-900" placeholder="Team name">
    <button class="btn btn-primary w-full mt-3" onclick="startTeam()">Start Hunt</button>`);
    $("#game").innerHTML=html; return;
  }
  html+=header(pct);
  if(index<STOPS.length){
    const cur=STOPS[index];
    html+=wrapCard(`<div class="text-sm text-gray-400 mb-1">Stop #${index+1}: <span class="font-semibold">${cur.business}</span></div>
      <h2 class="text-lg font-bold mb-1">${cur.title}</h2><p class="text-base">${cur.riddle}</p>`);
    html+=wrapCard(`<div class="text-sm text-gray-400 mb-2">Scan the checkpoint QR at <strong>${cur.business}</strong></div>
      <div id="camera" class="overflow-hidden rounded-lg border border-zinc-700">
        <video id="preview" style="width:100%;height:auto" autoplay muted playsinline></video>
      </div>
      <div class="text-xs text-gray-500 mt-2">If the camera doesnâ€™t start, allow camera permissions in your browser.</div>`);
    $("#game").innerHTML=html; startScanner(cur.id);
  }else{
    html+=wrapCard(`<h1 class="text-2xl font-bold text-center">ðŸŽ‰ Completed!</h1>
      <p class="text-base text-center mt-1">Team <strong>${escapeHtml(team)}</strong> finished the Haunted Block Hunt!</p>`);
    $("#game").innerHTML=html;
    grandFinale(); // auto show
  }
}
function renderAdmin(){
  let html='';
  html+=wrapCard(`<div class="flex items-center justify-between">
    <h1 class="text-xl font-bold">Checkpoint QR Codes</h1>
    <div class="text-sm text-orange-400">Print and place at each business. Each QR encodes the stop id.</div>
  </div>`);
  html+=`<div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2">`;
  STOPS.forEach(s=>{
    html+=`<div class="card p-4"><div class="text-xs text-gray-400">${s.business}</div>
      <div class="font-bold">${s.title}</div><div id="qr-${s.id}" class="flex items-center justify-center my-3"></div>
      <div class="text-xs text-gray-400 break-all">${s.id}</div></div>`;
  });
  html+=`</div>`;
  $("#game").innerHTML=html;
  STOPS.forEach(s=> new QRCode(document.getElementById(`qr-${s.id}`), { text:s.id, width:180, height:180, correctLevel: QRCode.CorrectLevel.M }));
}
function renderStats(){ $("#game").innerHTML=wrapCard(`<h1 class="text-xl font-bold">Stats</h1><p class="text-sm text-gray-400">Local-only counters on this device.</p>`); }
function startTeam(){ enableSFX(); const inp=$("#teamInput"); const t=(inp.value||'').trim(); if(!t) return; team=t; index=0; save(); render(); }
function resetProgress(){ localStorage.removeItem(KEY('team')); localStorage.removeItem(KEY('index')); team=''; index=0; closeFinale(); render(); }

/* Per-scan FX */
function showMegaWinFX(){
  if(navigator.vibrate) navigator.vibrate([40,40,60]);
  const flash=document.getElementById('fx-flash'), vig=document.getElementById('fx-vig');
  document.documentElement.classList.add('shake'); flash.classList.add('show'); vig.classList.add('show');
  setTimeout(()=>{ flash.classList.remove('show'); vig.classList.remove('show'); document.documentElement.classList.remove('shake'); }, 650);
  const center=document.getElementById('fx-center'), banner=document.getElementById('fx-banner');
  center.classList.add('show'); banner.classList.add('show'); setTimeout(()=>{ center.classList.remove('show'); banner.classList.remove('show'); }, 950);
  spawnPumpkinBurst(180); spawnLightBats(18);
}

/* ===== Scanner (robust with status chip) ===== */
let codeReader; let scanLock = false;

function normalizeQRText(txt){
  if(!txt) return '';
  let t = (''+txt).trim();
  try { t = decodeURIComponent(t); } catch(e){}
  if (/^https?:/i.test(t)) {
    try {
      const u = new URL(t);
      const cand = u.searchParams.get('id') || u.searchParams.get('stop') ||
                   (u.hash||'').replace(/^#/,'') ||
                   u.pathname.split('/').filter(Boolean).pop();
      if (cand) return cand.trim().toLowerCase();
    } catch(e){}
  }
  return t.toLowerCase();
}

async function startScanner(expectedId){
  stopScanner();
  scanLock = false;

  const chip = document.createElement('div');
  chip.id = 'camStatus';
  chip.style.cssText = 'position:fixed;top:8px;left:8px;z-index:9999;background:#111827;color:#fef3c7;border:1px solid #374151;border-radius:8px;padding:6px 8px;font:12px/1.2 monospace';
  chip.textContent = 'Camera: startingâ€¦';
  document.body.appendChild(chip);

  const insecure = location.protocol !== 'https:' && location.hostname !== 'localhost' && location.protocol !== 'file:';
  if (insecure) chip.textContent = 'Camera blocked: use HTTPS or localhost';

  try { await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' } } }); } catch(e){}

  const expectedNorm = normalizeQRText(expectedId);
  codeReader = new ZXing.BrowserMultiFormatReader();

  try {
    let devices = [];
    try { devices = await ZXing.BrowserMultiFormatReader.listVideoInputDevices(); } catch(_) {}
    let camId = null;
    if (devices && devices.length) {
      chip.textContent = `Camera: ${devices.length} found`;
      const back = devices.find(d => /back|rear|environment/i.test(d.label));
      camId = (back || devices[0]).deviceId;
    } else {
      chip.textContent = 'Camera: using default';
    }

    await codeReader.decodeFromVideoDevice(camId, 'preview', (result, err) => {
      if (err && !(err instanceof ZXing.NotFoundException)) {
        chip.textContent = `Camera error: ${err?.message || err}`;
      }
      if (!result || scanLock) return;

      const got = normalizeQRText(result.getText());
      const hit = (got === expectedNorm) || (got.includes('stop-') && got.includes(expectedNorm));
      if (!hit) return;

      scanLock = true;
      chip.textContent = 'Scan: matched!';
      showMegaWinFX();
      playHitRandom(); setTimeout(playHitRandom, 420);

      index++; save();
      if (index >= STOPS.length) localStorage.setItem(KEY('completed'), '1');

      stopScanner();
      setTimeout(() => { chip.remove(); render(); }, 520);
    });
  } catch (e) {
    chip.textContent = `Init error: ${e?.message || e}`;
    document.getElementById('camera')
      ?.insertAdjacentHTML('afterend', `<div class="text-xs text-red-300 mt-2">Camera error: ${e?.message||e}</div>`);
  }
}
function stopScanner(){ try { codeReader && codeReader.reset(); } catch(e){}; document.getElementById('camStatus')?.remove(); }

/* Boot */
render();
</script>
</body>
</html>

